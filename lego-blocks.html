<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lego Blocks Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="assets/css/lego-settings.css" />

  <!-- Modal centering/sizing to match Edit -->
  <style>
    /* Ensure both Add & Edit modals are centered and consistent */
    .modal-overlay { position: fixed; inset: 0; display: none; z-index: 2000; }
    .modal-overlay[aria-hidden="false"] { display: flex; align-items: center; justify-content: center; }
    .modal-overlay .modal { max-width: 960px; width: min(960px, 92vw); max-height: 90vh; overflow: auto; }
  </style>

  <!-- HARD GATE: keep app hidden until session + token -->
  <script>
    (function(){
      const SESSION_KEY='lego_admin_logged_in';
      const TOKEN_KEY='lego_admin_pat';
      document.documentElement.setAttribute('data-auth','locked');

      document.addEventListener('DOMContentLoaded', () => {
        const app  = document.getElementById('app');
        const gate = document.getElementById('gate');
        function locked(){
          return !(sessionStorage.getItem(SESSION_KEY)==='true' && sessionStorage.getItem(TOKEN_KEY));
        }
        function enforce(){
          if (!app || !gate) return;
          if (locked()){ app.style.display='none'; gate.style.display=''; }
        }
        enforce();
        const mo = new MutationObserver(enforce);
        mo.observe(document.body, { attributes:true, childList:true, subtree:true });

        window.__authGuard = {
          unlock(){
            sessionStorage.setItem(SESSION_KEY,'true');
            document.documentElement.setAttribute('data-auth','unlocked');
            mo.disconnect();
            if (app) app.style.display='';
            if (gate) gate.style.display='none';
          },
          lock(){
            sessionStorage.removeItem(SESSION_KEY);
            sessionStorage.removeItem(TOKEN_KEY);
            document.documentElement.setAttribute('data-auth','locked');
            enforce();
          }
        };
      });
    })();
  </script>
</head>
<body>
  <div class="bg-fixed bg-lego"></div>

  <header class="nav-wrap container">
    <div class="nav panel">
      <div class="brand">
        <img class="brand-logo" src="./assets/images/ey.png" alt="EY Logo" />
        <span>GDS Consulting Visit Lego Blocks</span>
      </div>
      <ul class="menu">
        <li><a href="index.html#home">Home</a></li>
        <li>
          <a href="#settings" id="menuSettings">Settings ▾</a>
          <ul class="submenu">
            <li>
              <a href="lego-blocks.html" id="menuLegoBlocks" role="menuitem" style="display:block;padding:10px 12px;border-radius:8px">
                Lego Blocks
              </a>
            </li>
          </ul>
        </li>
        <li><a href="index.html#contact">Contact Us</a></li>
        <li><a href="#" id="logoutLink" style="display:none">Logout</a></li>
      </ul>
    </div>
  </header>

  <!-- APP (hidden until login + PAT) -->
  <div id="app" style="display:none">
    <main class="wrap" id="settings">
      <section class="panel hero hero-tight">
        <h1>Lego Blocks Settings</h1>
        <p>Manage records, tiers, links, and attachments for your visit building blocks.</p>
        <div class="toolbar row-actions">
          <input id="search" type="text" placeholder="Search records…" />
        </div>
      </section>

      <section class="panel adv">
        <div class="records-head">
          <div class="left">
            <div class="card-title">Records</div>
            <button class="btn btn-cta" id="openAddBtn">+ Add record</button>
          </div>
          <div class="right tiny-links">
            <a href="#" id="exportLink">Export</a>
            <a href="#" id="importLink">Import</a>
            <a href="#" id="clearAllLink">Clear All</a>
            <span class="count" id="countPill">0 records</span>
            <input type="file" id="csvFile" accept=".csv,text/csv" style="display:none" />
          </div>
        </div>

        <div class="card-body glass-inner">
          <div class="table-wrap">
            <table id="dataTable" aria-describedby="countPill">
              <thead>
                <tr>
                  <th class="cat">Category</th>
                  <th class="phase">Phase</th>
                  <th class="activity">Activity</th>
                  <th class="outcome">Key Outcome / Key Message</th>
                  <th class="tier-col">T1</th>
                  <th class="tier-col">T1.1</th>
                  <th class="tier-col">T1.2</th>
                  <th class="tier-col">T2</th>
                  <th class="tier-col">T2.1</th>
                  <th class="tier-col">T3</th>
                  <th class="tier-col">T3.1</th>
                  <th class="tier-col">T3.2</th>
                  <th class="actions">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="muted" style="margin-top:12px">
            Tip: You can download/upload multiple records at once. To upload, download this
            <a href="#" id="templateCsvLink">Import template.csv</a>
            and import using the links above.
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- LOGIN GATE -->
  <div id="gate" class="gate" aria-hidden="false">
    <div class="gate-card panel">
      <div class="gate-header">
        <h2>Admin Sign-in</h2>
        <p class="muted">Enter your admin credentials, then provide a GitHub token for saving.</p>
      </div>
      <div class="gate-form">
        <div class="field">
          <label for="gateUser">Username</label>
          <input id="gateUser" type="text" placeholder="Username" autocomplete="username" autofocus />
        </div>
        <div class="field">
          <label for="gatePass">Password</label>
          <input id="gatePass" type="password" placeholder="Password" autocomplete="current-password" />
        </div>

        <!-- Revealed ONLY after username/password are correct -->
        <div class="field" id="patRow" style="display:none">
          <label for="gatePat">GitHub PAT (Contents: read/write)</label>
          <input id="gatePat" type="password" placeholder="ghp_…" />
          <div class="muted" style="margin-top:6px">Token is kept for this tab until you close it.</div>
        </div>

        <div class="actions">
          <button type="button" class="btn btn-cta" id="gateEnter">Enter</button>
        </div>
        <div class="muted" id="gateError" style="display:none;color:#d33;margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- DETAILS modal -->
  <div class="modal-overlay" id="detailsOverlay" aria-hidden="true">
    <div class="modal panel" role="dialog" aria-modal="true" aria-labelledby="detailsTitle">
      <div class="modal-header">
        <div class="modal-title" id="detailsTitle">Record Details</div>
        <button class="btn btn-ghost" id="closeDetailsBtn">Close</button>
      </div>
      <div class="modal-body"><div id="detailsBody"></div></div>
      <div class="modal-footer">
        <button class="btn btn-ghost" id="detailsEditBtn">Edit</button>
        <button class="btn btn-danger" id="detailsDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit modal -->
  <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
    <div class="modal panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Add Record</div>
        <button class="btn btn-ghost" id="closeModalBtn">Close</button>
      </div>
      <form id="recordForm">
        <input type="hidden" id="recordId" />
        <div class="modal-body">
          <div class="section">
            <div class="section-title">Core Details</div>
            <div class="grid-3">
              <div>
                <label>Category<span class="req">*</span></label>
                <select id="category" required>
                  <option value="">— Select —</option>
                  <option>Preparation</option><option>Presentation</option><option>Group Meet</option>
                  <option>Experience</option><option>Collaboration</option><option>Post Event</option>
                </select>
              </div>
              <div>
                <label>Phase<span class="req">*</span></label>
                <select id="phase" required>
                  <option value="">— Select —</option>
                  <option>PRE</option><option>DURING</option><option>POST</option>
                </select>
              </div>
              <div>
                <label>Activity<span class="req">*</span></label>
                <input type="text" id="activity" placeholder="e.g., Welcome & Registration" required />
              </div>
              <div style="grid-column:1/-1">
                <label>Key Outcome / Key Message<span class="req">*</span></label>
                <textarea id="outcome" placeholder="What success looks like / key talking points" required></textarea>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Ownership</div>
            <div class="grid-3">
              <div>
                <label>Presentation Owner</label>
                <input type="text" id="presentationOwner" placeholder="Name / team" />
              </div>
              <div>
                <label>Content Owner</label>
                <input type="text" id="contentOwner" placeholder="Name / team" />
              </div>
              <div style="grid-column:1/-1">
                <label>Notes</label>
                <textarea id="notes" placeholder="Internal notes or reminders"></textarea>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Tiers<span class="req"> *</span></div>
            <div class="tier-grid">
              <div><label>Tier 1</label><select class="tier" id="tier_1" required></select></div>
              <div><label>Tier 1.1</label><select class="tier" id="tier_1_1" required></select></div>
              <div><label>Tier 1.2</label><select class="tier" id="tier_1_2" required></select></div>
              <div><label>Tier 2</label><select class="tier" id="tier_2" required></select></div>
              <div><label>Tier 2.1</label><select class="tier" id="tier_2_1" required></select></div>
              <div><label>Tier 3</label><select class="tier" id="tier_3" required></select></div>
              <div><label>Tier 3.1</label><select class="tier" id="tier_3_1" required></select></div>
              <div><label>Tier 3.2</label><select class="tier" id="tier_3_2" required></select></div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">URL / Links</div>
            <div id="linksContainer" class="links-container"></div>
            <div><button type="button" class="btn btn-ghost btn-sm" id="addLinkBtn">+ Add Link</button></div>
            <div class="muted">Label is what appears in the list.</div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" id="resetBtn">Reset</button>
          <button type="button" class="btn btn-danger" id="editDeleteBtn" style="display:none">Delete</button>
          <button type="submit" class="btn btn-cta" id="submitBtn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Base scripts (ORDER MATTERS) -->
  <script src="assets/js/script.js"></script>
  <script src="assets/js/storage-xml-github.js"></script>
  <script src="assets/js/lego-settings.js"></script>

  <!-- Safety net: inline adapter only if external didn't load -->
  <script>
  (function(){
    if (window.XmlGitHubStorage) return;

    const OWNER  = 'markcolobong';
    const REPO   = 'cnslegoblocks';
    const BRANCH = 'main';
    const FILE_PATH = 'data/records.xml';
    const RAW_URL      = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${FILE_PATH}`;
    const CONTENTS_URL = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`;

    let GITHUB_TOKEN = null;
    const sanitizeToken = t => (t||'').trim().replace(/^[\"']+|[\"']+$/g,'').replace(/\s+/g,'').replace(/[\u200B-\u200D\uFEFF]/g,'');
    function cssEscape(s){ return String(s ?? '').replace(/"/g, '\\"'); }
    function base64EncodeUtf8(str){ return btoa(unescape(encodeURIComponent(str))); }
    function decodeBase64Utf8(b64){ try { return decodeURIComponent(escape(atob(b64))); } catch { return ''; } }
    async function ghFetch(url, init={}){
      const headers = Object.assign({ 'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28' }, init.headers||{});
      const tok = sanitizeToken(GITHUB_TOKEN||'');
      if (!tok) return fetch(url, Object.assign({}, init, { headers }));
      let r = await fetch(url, Object.assign({}, init, { headers: Object.assign({}, headers, { Authorization:`token ${tok}` }) }));
      if (r.status!==401) return r;
      r = await fetch(url, Object.assign({}, init, { headers: Object.assign({}, headers, { Authorization:`Bearer ${tok}` }) }));
      if (r.status!==401) return r;
      return fetch(url, Object.assign({}, init, { headers: Object.assign({}, headers, { Authorization:'Basic '+btoa('x:'+tok) }) }));
    }
    function parseXmlToRecords(xmlText){
      const parser = new DOMParser(); const doc = parser.parseFromString(xmlText,'application/xml');
      if (doc.querySelector('parsererror')) return []; const root = doc.querySelector('Records'); if (!root) return [];
      const records=[]; root.querySelectorAll('Record').forEach(node=>{
        const text = tag => (node.querySelector(tag)?.textContent ?? '');
        const tier = name => { const el=node.querySelector(`Tiers > T[name="${cssEscape(name)}"]`); return el ? el.textContent : 'Applicable'; };
        const id = node.getAttribute('id') || '';
        const links=[]; node.querySelectorAll('Links > Link').forEach(L=>{ links.push({label:L.getAttribute('label')||'',url:L.getAttribute('url')||''}); });
        records.push({
          id, category:text('Category'), phase:text('Phase'), activity:text('Activity'), outcome:text('Outcome'),
          presentationOwner:text('PresentationOwner'), contentOwner:text('ContentOwner'), notes:text('Notes'),
          links, tiers:{ tier_1:tier('tier_1'), tier_1_1:tier('tier_1_1'), tier_1_2:tier('tier_1_2'),
            tier_2:tier('tier_2'), tier_2_1:tier('tier_2_1'), tier_3:tier('tier_3'),
            tier_3_1:tier('tier_3_1'), tier_3_2:tier('tier_3_2') }
        });
      }); return records;
    }
    function buildXml(records){
      const esc=s=>String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
      const escAttr=s=>String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&apos;");
      const tier=(name,val)=>`    <T name="${escAttr(name)}">${esc(val)}</T>\n`; const link=l=>`    <Link label="${escAttr(l.label||'')}" url="${escAttr(l.url||'')}"/>\n`;
      let out=`<?xml version="1.0" encoding="UTF-8"?>\n<Records version="1">\n`;
      for (const r of records){
        out += `  <Record id="${escAttr(r.id)}">\n`;
        out += `    <Category>${esc(r.category)}</Category>\n`;
        out += `    <Phase>${esc(r.phase)}</Phase>\n`;
        out += `    <Activity>${esc(r.activity)}</Activity>\n`;
        out += `    <Outcome>${esc(r.outcome)}</Outcome>\n`;
        out += `    <PresentationOwner>${esc(r.presentationOwner)}</PresentationOwner>\n`;
        out += `    <ContentOwner>${esc(r.contentOwner)}</ContentOwner>\n`;
        out += `    <Notes>${esc(r.notes)}</Notes>\n`;
        out += `    <Links>\n${(r.links||[]).map(link).join('')}    </Links>\n`;
        out += `    <Tiers>\n`;
        out += tier('tier_1',r.tiers?.tier_1); out += tier('tier_1_1',r.tiers?.tier_1_1); out += tier('tier_1_2',r.tiers?.tier_1_2);
        out += tier('tier_2',r.tiers?.tier_2); out += tier('tier_2_1',r.tiers?.tier_2_1); out += tier('tier_3',r.tiers?.tier_3);
        out += tier('tier_3_1',r.tiers?.tier_3_1); out += tier('tier_3_2',r.tiers?.tier_3_2);
        out += `    </Tiers>\n  </Record>\n`;
      } out+=`</Records>\n`; return out;
    }
    async function getCurrentSha(){
      const res = await ghFetch(`${CONTENTS_URL}?ref=${encodeURIComponent(BRANCH)}`, { method:'GET', cache:'no-store' });
      if (res.status===200){ const meta=await res.json(); return meta.sha||null; }
      if (res.status===404) return null; const t=await res.text(); throw new Error('Failed reading file metadata: '+t);
    }
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
    async function saveAllToGitHub(records,message){
      if (!GITHUB_TOKEN) throw new Error('Not authorized: missing GitHub token for write');
      const xml=buildXml(records); const content=base64EncodeUtf8(xml);
      for (let attempt=1; attempt<=4; attempt++){
        const sha = await getCurrentSha();
        const res = await ghFetch(CONTENTS_URL, { method:'PUT', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: message || 'Update data/records.xml', content, sha: sha || undefined, branch: BRANCH }) });
        if (res.ok) return;
        let msg=''; try{ msg=(await res.json())?.message||''; } catch { try{ msg=await res.text(); } catch{} }
        const conflict = res.status===409 || res.status===422 || /does not match|sha/i.test(msg);
        if (conflict && attempt<4){ await sleep(250*attempt); continue; }
        throw new Error(msg || ('GitHub save failed ('+res.status+')'));
      }
    }
    const XmlGitHubStorage = {
      setToken(t){ GITHUB_TOKEN = sanitizeToken(t); },
      hasToken(){ return !!GITHUB_TOKEN; },
      async load(){
        try{
          if (GITHUB_TOKEN){
            const res = await ghFetch(`${CONTENTS_URL}?ref=${encodeURIComponent(BRANCH)}`, { method:'GET', cache:'no-store' });
            if (res.status===404) return []; if (!res.ok) return [];
            const json=await res.json(); const xmlText=decodeBase64Utf8((json.content||'').replace(/\n/g,''));
            return parseXmlToRecords(xmlText);
          }
          const res = await fetch(RAW_URL, { cache:'no-store' }); if(!res.ok) return []; return parseXmlToRecords(await res.text());
        }catch{ return []; }
      },
      async upsertOne(record){
        const all = await this.load();
        const idx = all.findIndex(r => r.id === record.id);
        if (idx >= 0) all[idx] = record; else all.push(record);
        await saveAllToGitHub(all, 'Upsert record from Lego Settings UI');
      },
      async updateOneById(record){
        if (!record?.id) throw new Error('Missing record id');
        const all = await this.load();
        const idx = all.findIndex(r => r.id === record.id);
        if (idx === -1) throw new Error('Record not found: ' + record.id);
        all[idx] = record;
        await saveAllToGitHub(all, 'Update record ' + record.id + ' from Lego Settings UI');
      },
      async replaceAll(records){ await saveAllToGitHub(records, 'Replace all records from Lego Settings UI'); },
      async deleteOne(id){
        const all = await this.load();
        const next = all.filter(r => r.id !== id);
        await saveAllToGitHub(next, 'Delete record from Lego Settings UI');
      }
    };
    window.XmlGitHubStorage = XmlGitHubStorage;
  })();
  </script>

  <!-- Block any legacy PAT prompt -->
  <script>
    (function(){
      const _prompt = window.prompt;
      window.prompt = function(msg, def){
        if (/(personal access token|pat|records\.xml)/i.test(String(msg||''))) return '';
        return _prompt ? _prompt(msg, def) : null;
      };
    })();
  </script>

  <!-- Login + PAT (STRICT: verify token with GitHub before unlock) -->
  <script>
  (function(){
    const OWNER='markcolobong', REPO='cnslegoblocks', BRANCH='main', PATH='data/records.xml';
    const CONTENTS_URL = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}?ref=${encodeURIComponent(BRANCH)}`;

    const SESSION_KEY='lego_admin_logged_in';
    const TOKEN_KEY='lego_admin_pat';

    const logout=document.getElementById('logoutLink');
    const uEl=document.getElementById('gateUser');
    const pEl=document.getElementById('gatePass');
    const patRow=document.getElementById('patRow');
    const patEl=document.getElementById('gatePat');
    const enterBtn=document.getElementById('gateEnter');
    const errBox=document.getElementById('gateError');

    if (enterBtn) enterBtn.setAttribute('type','button');

    function sanitizeToken(t){
      return (t||'').trim().replace(/^[\"']+|[\"']+$/g,'').replace(/\s+/g,'').replace(/[\u200B-\u200D\uFEFF]/g,'');
    }
    function showErr(m){ errBox.textContent=m; errBox.style.display=''; }
    function clearErr(){ errBox.textContent=''; errBox.style.display='none'; }

    async function verifyToken(pat){
      const headers = { 'X-GitHub-Api-Version':'2022-11-28' };
      try{
        let r = await fetch(CONTENTS_URL, { cache:'no-store', headers:{...headers, Authorization:`token ${pat}`} });
        if (r.status !== 401) return r.status;
        r = await fetch(CONTENTS_URL, { cache:'no-store', headers:{...headers, Authorization:`Bearer ${pat}`} });
        if (r.status !== 401) return r.status;
        r = await fetch(CONTENTS_URL, { cache:'no-store', headers:{...headers, Authorization:'Basic '+btoa('x:'+pat)} });
        return r.status;
      }catch{
        return 0;
      }
    }

    function unlockUI(pat){
      sessionStorage.setItem(TOKEN_KEY, pat);
      sessionStorage.setItem(SESSION_KEY, 'true');
      if (window.XmlGitHubStorage?.setToken) XmlGitHubStorage.setToken(pat);
      if (window.__authGuard?.unlock) __authGuard.unlock();
      else {
        document.documentElement.setAttribute('data-auth','unlocked');
        const app=document.getElementById('app'), gate=document.getElementById('gate');
        if (app) app.style.display=''; if (gate) gate.style.display='none';
      }
      if (logout) logout.style.display='';
      document.getElementById('openAddBtn')?.removeAttribute('disabled');
    }

    function lockUI(){
      sessionStorage.removeItem(SESSION_KEY);
      sessionStorage.removeItem(TOKEN_KEY);
      if (window.XmlGitHubStorage?.setToken) XmlGitHubStorage.setToken(null);
      if (window.__authGuard?.lock) __authGuard.lock();
      else {
        document.documentElement.setAttribute('data-auth','locked');
        const app=document.getElementById('app'), gate=document.getElementById('gate');
        if (app) app.style.display='none'; if (gate) gate.style.display='';
      }
      if (logout) logout.style.display='none';
    }

    let credsVerified=false, busy=false;

    (async function resume(){
      const logged = sessionStorage.getItem(SESSION_KEY)==='true';
      const tok = sessionStorage.getItem(TOKEN_KEY);
      if (logged && tok){
        const status = await verifyToken(tok);
        if (status===200 || status===404){
          unlockUI(tok);
          try{ await window.LegoSettings?.refresh?.(); }catch{}
        }else{
          lockUI();
        }
      }else{
        lockUI();
      }
    })();

    enterBtn?.addEventListener('click', async (e)=>{
      e.preventDefault();
      if (busy) return;
      clearErr();

      if (!credsVerified){
        const u=(uEl.value||'').trim();
        const p=(pEl.value||'').trim();
        if (u!=='admin' || p!=='+mark'){ showErr('Invalid credentials. Please try again.'); return; }
        credsVerified = true;
        patRow.style.display = '';
        enterBtn.textContent = 'Use Token';
        patEl.focus();
        return;
      }

      const pat = sanitizeToken(patEl.value);
      if (!pat){ showErr('Please enter a valid GitHub token.'); patEl.focus(); return; }

      const prev = enterBtn.textContent;
      busy = true; enterBtn.disabled = true; enterBtn.textContent = 'Validating…';

      const status = await verifyToken(pat);
      if (status===200 || status===404){
        unlockUI(pat);
        try{ await window.LegoSettings?.refresh?.(); }catch{}
      }else{
        showErr(status===401 ? 'Token rejected (401).'
              : status===403 ? 'Token lacks repo access (403).'
              : status===0   ? 'Network/CSP error contacting GitHub.'
                             : `Auth failed: ${status}`);
        lockUI();
      }
      busy = false; enterBtn.disabled = false; enterBtn.textContent = prev || 'Use Token';
    });

    document.getElementById('logoutLink')?.addEventListener('click', (e)=>{
      e.preventDefault();
      lockUI();
      credsVerified=false;
      patRow.style.display='none';
      enterBtn.textContent='Enter';
      uEl.value=''; pEl.value=''; patEl.value='';
    });
  })();
  </script>

<!-- ADD: Append row only AFTER modal closes (post-save). No 'Saving…'. -->
<script>
(function(){
  const $  = (id)=>document.getElementById(id);
  const q  = (sel, el=document)=>el.querySelector(sel);
  const qa = (sel, el=document)=>Array.from(el.querySelectorAll(sel));
  const S  = (v)=>String(v ?? '');

  const overlay  = $('modalOverlay');
  const form     = $('recordForm');
  const idInput  = $('recordId');
  const modalTit = $('modalTitle');
  const linksBox = $('linksContainer');
  const countPill= $('countPill');
  const addBtn   = $('openAddBtn');

  if (!overlay || !form) return;

  // ----- helpers -----
  function parseCount(){ const m=(countPill?.textContent||'').match(/(\d+)/); return m?parseInt(m[1],10):NaN; }
  function setCount(n){ if (countPill && Number.isFinite(n)) countPill.textContent = `${n} records`; }
  function lastDomId(){
    const rows = qa('#dataTable tbody tr[data-id]');
    if (!rows.length) return '';
    return rows[rows.length-1].dataset.id || '';
  }
  function nextIdFromDom(){
    let cand; const last=lastDomId(); const m=last.match(/^(.*?)(\d+)$/);
    if (m){ const p=m[1], d=m[2]; cand = p + String(parseInt(d,10)+1).padStart(d.length,'0'); }
    else cand = 'r_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7);
    let guard=0;
    while (q(`#dataTable tbody tr[data-id="${CSS.escape(cand)}"]`) && guard<500){
      const mm=cand.match(/^(.*?)(\d+)$/);
      cand = mm ? (mm[1] + String(parseInt(mm[2],10)+1).padStart(mm[2].length,'0'))
                : ('r_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7));
      guard++;
    }
    return cand;
  }
  function pill(txt){
    const v=S(txt).trim();
    const span=document.createElement('span');
    const slug = v.toLowerCase().replace(/[^a-z0-9]+/g,'-') || 'blank';
    span.className = `pill pill-${slug}`;
    span.textContent = v;
    span.setAttribute('data-value', v);
    return span;
  }
  function td(nodeOrText, cls){
    const td=document.createElement('td');
    if (cls) td.className=cls;
    if (nodeOrText instanceof Node) td.appendChild(nodeOrText);
    else td.textContent = S(nodeOrText);
    return td;
  }
  function actionsCell(id){
    const tdA=document.createElement('td');
    tdA.className='actions';
    tdA.innerHTML = `
      <a href="#" class="tiny view-link" data-id="${id}">View</a>
      <span class="sep">•</span>
      <a href="#" class="tiny danger delete-link" data-id="${id}">Delete</a>
    `;
    return tdA;
  }

// REPLACE your existing appendRowImmediate with THIS version.
function appendRowImmediate(rec){
  const tb  = document.querySelector('#dataTable tbody');
  if (!tb) return;

  // Use the first existing row as a template for structure/styles
  const tpl = tb.querySelector('tr');
  let tr;

  if (tpl){
    // Clone the fully-styled row, then replace content
    tr = tpl.cloneNode(true);
    tr.dataset.id = rec.id;

    const cells = tr.querySelectorAll('td');

    // helpers to set cell content while preserving structure/classes
    const S = (v) => String(v ?? '');
    const setText = (idx, val) => {
      if (!cells[idx]) return;
      // Clear and set plain text
      cells[idx].innerHTML = '';
      cells[idx].textContent = S(val);
    };
    const setTier = (idx, val) => {
      if (!cells[idx]) return;
      const cell = cells[idx];

      // Try to find the existing pill/chip/badge node and update its text + data-value
      let pill = cell.querySelector('.pill, .badge, .chip, span');
      if (!pill){
        // If the template didn't have a pill node for some reason, fall back to plain text
        cell.innerHTML = '';
        cell.textContent = S(val);
        return;
      }
      pill.textContent = S(val);
      pill.setAttribute('data-value', S(val));
    };

    // 0..3: basic text columns
    setText(0, rec.category);
    setText(1, rec.phase);
    setText(2, rec.activity);
    setText(3, rec.outcome);

    // 4..11: tier columns (preserve pill structure/classes)
    setTier(4,  rec.tiers?.tier_1);
    setTier(5,  rec.tiers?.tier_1_1);
    setTier(6,  rec.tiers?.tier_1_2);
    setTier(7,  rec.tiers?.tier_2);
    setTier(8,  rec.tiers?.tier_2_1);
    setTier(9,  rec.tiers?.tier_3);
    setTier(10, rec.tiers?.tier_3_1);
    setTier(11, rec.tiers?.tier_3_2);

    // Actions: just re-point data-id so View/Delete work instantly
    const view = tr.querySelector('.view-link');
    const del  = tr.querySelector('.delete-link');
    if (view) view.setAttribute('data-id', rec.id);
    if (del)  del.setAttribute('data-id', rec.id);
  } else {
    // Fallback if there is no existing row to copy (empty table scenario)
    tr = document.createElement('tr');
    tr.dataset.id = rec.id;

    const S = (v) => String(v ?? '');
    const td = (nodeOrText, cls) => {
      const el = document.createElement('td');
      if (cls) el.className = cls;
      if (nodeOrText instanceof Node) el.appendChild(nodeOrText);
      else el.textContent = S(nodeOrText);
      return el;
    };

    const makePill = (val) => {
      const p = document.createElement('span');
      p.className = 'pill';                 // your CSS will style this
      p.setAttribute('data-value', S(val));
      p.textContent = S(val);
      return p;
    };

    tr.appendChild(td(rec.category, 'cat'));
    tr.appendChild(td(rec.phase, 'phase'));
    tr.appendChild(td(rec.activity, 'activity'));
    tr.appendChild(td(rec.outcome, 'outcome'));
    tr.appendChild(td(makePill(rec.tiers?.tier_1),   'tier-col'));
    tr.appendChild(td(makePill(rec.tiers?.tier_1_1), 'tier-col'));
    tr.appendChild(td(makePill(rec.tiers?.tier_1_2), 'tier-col'));
    tr.appendChild(td(makePill(rec.tiers?.tier_2),   'tier-col'));
    tr.appendChild(td(makePill(rec.tiers?.tier_2_1), 'tier-col'));
    tr.appendChild(td(makePill(rec.tiers?.tier_3),   'tier-col'));
    tr.appendChild(td(makePill(rec.tiers?.tier_3_1), 'tier-col'));
    tr.appendChild(td(makePill(rec.tiers?.tier_3_2), 'tier-col'));

    const actions = document.createElement('td');
    actions.className = 'actions';
    actions.innerHTML = `
      <a href="#" class="tiny view-link" data-id="${rec.id}">View</a>
      <span class="sep">•</span>
      <a href="#" class="tiny danger delete-link" data-id="${rec.id}">Delete</a>
    `;
    tr.appendChild(actions);
  }

  tb.appendChild(tr);
}

  // Make View/Delete work immediately for appended rows (delegated)
  (function bindDelegatesOnce(){
    if (document.__legoDelegatesBound) return;
    document.__legoDelegatesBound = true;

    // View
    document.addEventListener('click', async (e)=>{
      const a = e.target.closest && e.target.closest('.view-link'); if (!a) return;
      e.preventDefault();
      const id = a.getAttribute('data-id')||'';
      // Try current renderer first (it may already know about it), else fetch
      let rec = (window.__legoLocalRecords && window.__legoLocalRecords[id]);
      if (!rec && window.XmlGitHubStorage?.load){
        try{ const all=await XmlGitHubStorage.load(); rec=all.find(r=>r.id===id); }catch{}
      }
      if (!rec) return;
      const detailsOverlay=$('detailsOverlay'), body=$('detailsBody');
      if (detailsOverlay && body){
        body.innerHTML = `
          <div class="stack">
            <div><strong>Category:</strong> ${S(rec.category)}</div>
            <div><strong>Phase:</strong> ${S(rec.phase)}</div>
            <div><strong>Activity:</strong> ${S(rec.activity)}</div>
            <div><strong>Outcome:</strong> ${S(rec.outcome)}</div>
            <div><strong>Presentation Owner:</strong> ${S(rec.presentationOwner)}</div>
            <div><strong>Content Owner:</strong> ${S(rec.contentOwner)}</div>
            <div><strong>Notes:</strong> ${S(rec.notes)}</div>
            <div><strong>Links:</strong> ${(rec.links||[]).map(l=>`<a href="${S(l.url)}" target="_blank" rel="noopener">${S(l.label||l.url)}</a>`).join(' • ') || '—'}</div>
          </div>`;
        detailsOverlay.setAttribute('aria-hidden','false');
        $('closeDetailsBtn')?.addEventListener('click', ()=>detailsOverlay.setAttribute('aria-hidden','true'), {once:true});
        $('detailsEditBtn')?.addEventListener('click', ()=>{
          detailsOverlay.setAttribute('aria-hidden','true');
          if (idInput) idInput.value = rec.id;
          if (modalTit) modalTit.textContent = 'Edit Record';
          $('editDeleteBtn')?.style && ( $('editDeleteBtn').style.display = '' );
          const set=(i,v)=>{ const el=$(i); if (el) el.value=v||''; };
          set('category',rec.category); set('phase',rec.phase); set('activity',rec.activity); set('outcome',rec.outcome);
          set('presentationOwner',rec.presentationOwner); set('contentOwner',rec.contentOwner); set('notes',rec.notes);
          set('tier_1',rec.tiers?.tier_1); set('tier_1_1',rec.tiers?.tier_1_1); set('tier_1_2',rec.tiers?.tier_1_2);
          set('tier_2',rec.tiers?.tier_2); set('tier_2_1',rec.tiers?.tier_2_1); set('tier_3',rec.tiers?.tier_3);
          set('tier_3_1',rec.tiers?.tier_3_1); set('tier_3_2',rec.tiers?.tier_3_2);
          if (linksBox){
            linksBox.innerHTML=''; (rec.links||[]).forEach(l=>{
              const row=document.createElement('div'); row.className='link-row';
              row.innerHTML = `<input class="link-label" placeholder="Label" value="${S(l.label)}" />
                               <input class="link-url" placeholder="https://" value="${S(l.url)}" />`;
              linksBox.appendChild(row);
            });
          }
          overlay.setAttribute('aria-hidden','false'); form.dataset.mode='edit';
        }, {once:true});
        $('detailsDeleteBtn')?.addEventListener('click', async ()=>{
          detailsOverlay.setAttribute('aria-hidden','true');
          try{
            const row = q(`#dataTable tbody tr[data-id="${CSS.escape(id)}"]`);
            if (row?.parentNode) row.parentNode.removeChild(row);
            const c=parseCount(); if (!isNaN(c)) setCount(Math.max(0,c-1));
            await XmlGitHubStorage.deleteOne(id);
            try{ await window.LegoSettings?.refresh?.(); }catch{}
          }catch(err){ console.error(err); alert('Delete failed: '+(err?.message||err)); }
        }, {once:true});
      }
    });

    // Delete directly from table
    document.addEventListener('click', async (e)=>{
      const a=e.target.closest && e.target.closest('.delete-link'); if (!a) return;
      e.preventDefault(); const id=a.getAttribute('data-id')||'';
      const row=q(`#dataTable tbody tr[data-id="${CSS.escape(id)}"]`);
      if (row?.parentNode) row.parentNode.removeChild(row);
      const c=parseCount(); if (!isNaN(c)) setCount(Math.max(0,c-1));
      try{ await XmlGitHubStorage.deleteOne(id); try{ await window.LegoSettings?.refresh?.(); }catch{} }
      catch(err){ console.error(err); alert('Delete failed: '+(err?.message||err)); }
    });
  })();

  // ----- 1) Capture Add form submission to snapshot data & ensure the ID we want -----
  window.__legoLocalRecords = window.__legoLocalRecords || Object.create(null);
  let pendingAdd = null;

  form.addEventListener('submit', (e)=>{
    // Only for ADD mode (not edit): your existing edit save logic remains untouched
    const isCreate = (form.dataset.mode === 'create' && (!idInput || !idInput.value));
    if (!isCreate) return;

    // Build the *exact* record we want to appear in the table
    const rec = {
      id: nextIdFromDom(), // pre-pick id so save and UI match
      category: q('#category')?.value || '',
      phase: q('#phase')?.value || '',
      activity: q('#activity')?.value?.trim() || '',
      outcome: q('#outcome')?.value?.trim() || '',
      presentationOwner: q('#presentationOwner')?.value?.trim() || '',
      contentOwner: q('#contentOwner')?.value?.trim() || '',
      notes: q('#notes')?.value?.trim() || '',
      links: qa('#linksContainer .link-row').map(row => ({
        label: row.querySelector('.link-label')?.value || '',
        url:   row.querySelector('.link-url')?.value   || ''
      })),
      tiers: {
        tier_1:   q('#tier_1')?.value || '',
        tier_1_1: q('#tier_1_1')?.value || '',
        tier_1_2: q('#tier_1_2')?.value || '',
        tier_2:   q('#tier_2')?.value || '',
        tier_2_1: q('#tier_2_1')?.value || '',
        tier_3:   q('#tier_3')?.value || '',
        tier_3_1: q('#tier_3_1')?.value || '',
        tier_3_2: q('#tier_3_2')?.value || ''
      }
    };

    // Ensure your existing save code (which reads #recordId) uses THIS id
    if (idInput) idInput.value = rec.id;

    // Save for after-close append
    pendingAdd = rec;

    // Do NOT preventDefault — let your current handler save & close the modal
    // (We just observe the modal closing to append the row)
  }, true); // capture to run before your existing handler

  // ----- 2) When modal closes (aria-hidden="true") after save, append row instantly -----
  const mo = new MutationObserver(async (mlist)=>{
    for (const m of mlist){
      if (m.type==='attributes' && m.attributeName==='aria-hidden'){
        const nowHidden = overlay.getAttribute('aria-hidden') === 'true';
        if (nowHidden && pendingAdd){
          const rec = pendingAdd; pendingAdd = null;

          // Add row immediately with pills + actions, bump count
          appendRowImmediate(rec);
          const c=parseCount(); if (!isNaN(c)) setCount(c+1);

          // Keep local cache so View/Delete work immediately
          window.__legoLocalRecords[rec.id] = rec;

          // Gentle reconcile so your canonical renderer rebinds everything
          try{ await window.LegoSettings?.refresh?.(); }catch{}
          setTimeout(()=>{ try{ window.LegoSettings?.refresh?.(); }catch{} }, 200);
        }
      }
    }
  });
  mo.observe(overlay, { attributes:true, attributeFilter:['aria-hidden'] });

  // Safety: ensure "+ Add record" always reopens in Add mode
  if (addBtn){
    addBtn.addEventListener('click', ()=>{
      if (modalTit) modalTit.textContent = 'Add Record';
      if (idInput) idInput.value = '';
      $('editDeleteBtn')?.style && ( $('editDeleteBtn').style.display = 'none' );
      form.dataset.mode = 'create';
    });
  }
})();
</script>



  <!-- CSS tip (your theme likely already has this):
       .modal-overlay[aria-hidden="true"] { display:none; }
       .modal-overlay[aria-hidden="false"] { display:flex; align-items:center; justify-content:center; }
  -->
  <!-- Hard-fix: ensure "+ Add record" always opens the Add modal -->
<script>
(function(){
  function openAddModal(){
    var overlay    = document.getElementById('modalOverlay');
    var form       = document.getElementById('recordForm');
    var idInput    = document.getElementById('recordId');
    var delBtn     = document.getElementById('editDeleteBtn');
    var modalTitle = document.getElementById('modalTitle');

    if (!overlay || !form) return;

    // Reset to pristine Add state
    try { form.reset(); } catch {}
    if (idInput) idInput.value = '';
    form.dataset.mode = 'create';
    if (modalTitle) modalTitle.textContent = 'Add Record';
    if (delBtn) delBtn.style.display = 'none';

    // Show (CSS handles centering/sizing)
    overlay.setAttribute('aria-hidden','false');

    // Focus first useful field
    var first = form.querySelector('input,select,textarea');
    if (first) first.focus();
  }

  function bind(){
    var btn = document.getElementById('openAddBtn');
    if (!btn) return;

    // avoid form submit semantics
    btn.setAttribute('type','button');
    btn.removeAttribute('disabled');

    // Capture-phase handler so nothing else can block it
    function captureOpen(e){
      var t = e.target && e.target.closest ? e.target.closest('#openAddBtn') : null;
      if (!t) return;
      e.preventDefault();
      e.stopImmediatePropagation();
      openAddModal();
    }

    // Earliest hooks
    document.addEventListener('pointerdown', captureOpen, true);
    document.addEventListener('click',       captureOpen, true);

    // Direct fallback on the button
    btn.onclick = function(e){
      e.preventDefault();
      e.stopImmediatePropagation();
      openAddModal();
    };
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bind);
  } else {
    bind();
  }
})();
</script>

</body>
</html>









