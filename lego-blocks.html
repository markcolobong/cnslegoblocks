<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lego Blocks Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="assets/css/lego-settings.css" />
</head>
<body>
  <!-- Themed fixed background for this page -->
  <div class="bg-fixed bg-lego"></div>

  <!-- NAVBAR (same as index) -->
  <header class="nav-wrap container">
    <div class="nav panel">
      <div class="brand">
        <img class="brand-logo" src="./assets/images/ey.png" alt="EY Logo" />
        <span>GDS Consulting Visit Lego Blocks</span>
      </div>
      <ul class="menu">
        <li><a href="index.html#home">Home</a></li>
        <li>
          <a href="#settings" id="menuSettings">Settings ▾</a>
          <ul class="submenu">
            <li>
              <a href="lego-blocks.html" id="menuLegoBlocks" role="menuitem" style="display:block;padding:10px 12px;border-radius:8px">
                Lego Blocks
              </a>
            </li>
            
          </ul>
        </li>
        <li><a href="index.html#contact">Contact Us</a></li>
      </ul>
    </div>
  </header>

  <!-- Page content (hidden until login) -->
  <div id="app" style="display:none">
    <main class="wrap" id="settings">
      <!-- Top canvas -->
      <section class="panel hero hero-tight">
        <h1>Lego Blocks Settings</h1>
        <p>Manage records, tiers, links, and attachments for your visit building blocks.</p>
        <div class="toolbar row-actions">
          <input id="search" type="text" placeholder="Search records…" />
        </div>
      </section>

      <!-- Records canvas -->
      <section class="panel adv">
        <div class="records-head">
          <div class="left">
            <div class="card-title">Records</div>
            <button class="btn btn-cta" id="openAddBtn">+ Add record</button>
          </div>
          <div class="right tiny-links">
            <a href="#" id="exportLink">Export</a>
            <a href="#" id="importLink">Import</a>
            <a href="#" id="clearAllLink">Clear All</a>
            <span class="count" id="countPill">0 records</span>
            <input type="file" id="csvFile" accept=".csv,text/csv" style="display:none" />
          </div>
        </div>

        <div class="card-body glass-inner">
          <div class="table-wrap">
            <table id="dataTable" aria-describedby="countPill">
              <thead>
              <tr>
                <th class="cat">Category</th>
                <th class="phase">Phase</th>
                <th class="activity">Activity</th>
                <th class="outcome">Key Outcome / Key Message</th>
                <th class="tier-col">T1</th>
                <th class="tier-col">T1.1</th>
                <th class="tier-col">T1.2</th>
                <th class="tier-col">T2</th>
                <th class="tier-col">T2.1</th>
                <th class="tier-col">T3</th>
                <th class="tier-col">T3.1</th>
                <th class="tier-col">T3.2</th>
                <th class="actions">Actions</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="muted" style="margin-top:12px">
            Tip: You can download/upload multiple records at once. To upload, download this
            <a href="#" id="templateCsvLink">Import template.csv</a>
            and import using the links above.
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Admin login -->
  <div id="gate" class="gate" aria-hidden="false">
    <div class="gate-card panel">
      <div class="gate-header">
        <h2>Admin Sign-in</h2>
        <p class="muted">Enter your credentials to manage Lego Blocks settings.</p>
      </div>
      <div class="gate-form">
        <div class="field">
          <label for="gateUser">Username</label>
          <input id="gateUser" type="text" placeholder="Username" autocomplete="username" autofocus />
        </div>
        <div class="field">
          <label for="gatePass">Password</label>
          <input id="gatePass" type="password" placeholder="Password" autocomplete="current-password" />
        </div>
        <div class="actions">
          <button class="btn btn-cta" id="gateEnter">Enter</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DETAILS modal -->
  <div class="modal-overlay" id="detailsOverlay" aria-hidden="true">
    <div class="modal panel" role="dialog" aria-modal="true" aria-labelledby="detailsTitle">
      <div class="modal-header">
        <div class="modal-title" id="detailsTitle">Record Details</div>
        <button class="btn btn-ghost" id="closeDetailsBtn">Close</button>
      </div>
      <div class="modal-body"><div id="detailsBody"></div></div>
      <div class="modal-footer">
        <button class="btn btn-ghost" id="detailsEditBtn">Edit</button>
        <button class="btn btn-danger" id="detailsDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit modal -->
  <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
    <div class="modal panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Add Record</div>
        <button class="btn btn-ghost" id="closeModalBtn">Close</button>
      </div>

      <form id="recordForm">
        <input type="hidden" id="recordId" />
        <div class="modal-body">
          <div class="section">
            <div class="section-title">Core Details</div>
            <div class="grid-3">
              <div>
                <label>Category<span class="req">*</span></label>
                <select id="category" required>
                  <option value="">— Select —</option>
                  <option>Preparation</option><option>Presentation</option><option>Group Meet</option>
                  <option>Experience</option><option>Collaboration</option><option>Post Event</option>
                </select>
              </div>
              <div>
                <label>Phase<span class="req">*</span></label>
                <select id="phase" required>
                  <option value="">— Select —</option>
                  <option>PRE</option><option>DURING</option><option>POST</option>
                </select>
              </div>
              <div>
                <label>Activity<span class="req">*</span></label>
                <input type="text" id="activity" placeholder="e.g., Welcome & Registration" required />
              </div>
              <div style="grid-column:1/-1">
                <label>Key Outcome / Key Message<span class="req">*</span></label>
                <textarea id="outcome" placeholder="What success looks like / key talking points" required></textarea>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Ownership</div>
            <div class="grid-3">
              <div>
                <label>Presentation Owner</label>
                <input type="text" id="presentationOwner" placeholder="Name / team" />
              </div>
              <div>
                <label>Content Owner</label>
                <input type="text" id="contentOwner" placeholder="Name / team" />
              </div>
              <div style="grid-column:1/-1">
                <label>Notes</label>
                <textarea id="notes" placeholder="Internal notes or reminders"></textarea>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Tiers<span class="req"> *</span></div>
            <div class="tier-grid">
              <div><label>Tier 1</label><select class="tier" id="tier_1" required></select></div>
              <div><label>Tier 1.1</label><select class="tier" id="tier_1_1" required></select></div>
              <div><label>Tier 1.2</label><select class="tier" id="tier_1_2" required></select></div>
              <div><label>Tier 2</label><select class="tier" id="tier_2" required></select></div>
              <div><label>Tier 2.1</label><select class="tier" id="tier_2_1" required></select></div>
              <div><label>Tier 3</label><select class="tier" id="tier_3" required></select></div>
              <div><label>Tier 3.1</label><select class="tier" id="tier_3_1" required></select></div>
              <div><label>Tier 3.2</label><select class="tier" id="tier_3_2" required></select></div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">URL / Links</div>
            <div id="linksContainer" class="links-container"></div>
            <div><button type="button" class="btn btn-ghost btn-sm" id="addLinkBtn">+ Add Link</button></div>
            <div class="muted">Label is what appears in the list.</div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" id="resetBtn">Reset</button>
          <button type="button" class="btn btn-danger" id="editDeleteBtn" style="display:none">Delete</button>
          <button type="submit" class="btn btn-cta" id="submitBtn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script src="assets/js/script.js"></script>
<script src="../assets/js/storage-xml-github.js"></script>
  <script src="assets/js/lego-settings.js"></script>

  <!-- GitHub Save Widget -->
<section id="gh-save" style="margin:16px 0; padding:16px; border:1px solid #ddd; border-radius:12px;">
  <h3 style="margin:0 0 8px;">Save Records to GitHub</h3>

  <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
    <input id="ghToken" type="password" placeholder="Paste GitHub PAT"
           style="flex:1; min-width:260px; padding:8px 10px; border:1px solid #ccc; border-radius:8px;">
    <button id="btnRemember" type="button">Remember (this session)</button>
    <button id="btnLoad" type="button">Load current XML</button>
    <button id="btnSave" type="button" style="background:#1f883d; color:#fff; border:0; padding:8px 14px; border-radius:8px;">
      SAVE to /data/records.xml
    </button>
  </div>

  <!-- Optional JSON editor fallback (used if you don't provide window.collectRecords) -->
  <details style="margin-top:10px;">
    <summary>Edit as JSON (fallback)</summary>
    <p style="margin:8px 0 4px; color:#555;">If your page doesn’t define <code>window.collectRecords()</code>,
       the SAVE button will read records from this JSON textbox.</p>
    <textarea id="recordsJson" rows="12" style="width:100%; font-family:ui-monospace,Consolas,monospace; padding:10px; border:1px solid #ccc; border-radius:8px;">
[
  {
    "id": "example-1",
    "category": "Planning",
    "phase": "Pre-Visit",
    "activity": "Agenda Review",
    "outcome": "Aligned agenda",
    "presentationOwner": "Owner A",
    "contentOwner": "Owner B",
    "notes": "Sample note",
    "links": [
      {"label": "Deck", "url": "https://example.com/deck"}
    ],
    "tiers": {
      "tier_1": "Applicable",
      "tier_1_1": "Applicable",
      "tier_1_2": "Applicable",
      "tier_2": "Applicable",
      "tier_2_1": "Applicable",
      "tier_3": "Applicable",
      "tier_3_1": "Applicable",
      "tier_3_2": "Applicable"
    }
  }
]
    </textarea>
  </details>

  <div id="ghStatus" style="margin-top:10px; font-size:14px; color:#555;"></div>
</section>

<script>
  (function(){
    const $ = (sel) => document.querySelector(sel);
    const $token = $('#ghToken');
    const $status = $('#ghStatus');
    const $json = $('#recordsJson');

    // Prefill token if remembered in this browser session
    const saved = sessionStorage.getItem('lego_gh_pat');
    if (saved) $token.value = saved;

    function setStatus(msg, good){
      $status.textContent = msg || '';
      $status.style.color = good ? '#1f883d' : '#a40e26';
    }

    // Remember token for the current browser tab session
    $('#btnRemember').addEventListener('click', () => {
      const t = ($token.value || '').trim();
      if (!t) { setStatus('Please paste a PAT first.', false); return; }
      sessionStorage.setItem('lego_gh_pat', t);
      setStatus('PAT stored for this session.', true);
    });

    // Load current XML (shows parsed records in JSON box, if you want to inspect)
    $('#btnLoad').addEventListener('click', async () => {
      try{
        const token = ($token.value || sessionStorage.getItem('lego_gh_pat') || '').trim();
        if (token) XmlGitHubStorage.setToken(token); // not required for read, but fine
        setStatus('Loading current XML...', true);

        const records = await XmlGitHubStorage.load(); // array of records from your module
        $json.value = JSON.stringify(records, null, 2);
        setStatus(`Loaded ${records.length} record(s) from data/records.xml.`, true);
      }catch(err){
        console.error(err);
        setStatus('Failed loading current XML. See console for details.', false);
      }
    });

    // Main SAVE action
    $('#btnSave').addEventListener('click', async () => {
      try{
        const token = ($token.value || sessionStorage.getItem('lego_gh_pat') || '').trim();
        if (!token) { setStatus('Missing PAT. Paste your GitHub PAT first.', false); return; }
        XmlGitHubStorage.setToken(token);

        // Prefer your app’s own collector if available
        let records;
        if (typeof window.collectRecords === 'function') {
          records = window.collectRecords(); // must return array of { id, category, phase, activity, outcome, presentationOwner, contentOwner, notes, links[], tiers{} }
        } else {
          // Fallback: read from JSON textarea
          try{
            records = JSON.parse($json.value || '[]');
          }catch(parseErr){
            setStatus('JSON is invalid. Fix the JSON in the editor or provide window.collectRecords().', false);
            return;
          }
        }

        if (!Array.isArray(records)) {
          setStatus('Records must be an array. Check your data or window.collectRecords().', false);
          return;
        }

        setStatus('Saving to GitHub...', true);
        await XmlGitHubStorage.replaceAll(records);
        setStatus('✅ Saved! Committed to /data/records.xml on the configured branch.', true);
      }catch(err){
        console.error(err);
        setStatus('❌ Save failed: ' + (err && err.message ? err.message : 'Unknown error'), false);
      }
    });
  })();
</script>

</body>
</html>

