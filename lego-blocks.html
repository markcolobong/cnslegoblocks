<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lego Blocks Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="assets/css/lego-settings.css" />

  <!-- HARD GATE: keep app hidden until session + token -->
  <script>
    (function(){
      const SESSION_KEY='lego_admin_logged_in';
      const TOKEN_KEY='lego_admin_pat';
      document.documentElement.setAttribute('data-auth','locked');

      document.addEventListener('DOMContentLoaded', () => {
        const app  = document.getElementById('app');
        const gate = document.getElementById('gate');
        function locked(){
          return !(sessionStorage.getItem(SESSION_KEY)==='true' && sessionStorage.getItem(TOKEN_KEY));
        }
        function enforce(){
          if (!app || !gate) return;
          if (locked()){ app.style.display='none'; gate.style.display=''; }
        }
        enforce();
        const mo = new MutationObserver(enforce);
        mo.observe(document.body, { attributes:true, childList:true, subtree:true });

        window.__authGuard = {
          unlock(){
            sessionStorage.setItem(SESSION_KEY,'true');
            document.documentElement.setAttribute('data-auth','unlocked');
            mo.disconnect();
            if (app) app.style.display='';
            if (gate) gate.style.display='none';
          },
          lock(){
            sessionStorage.removeItem(SESSION_KEY);
            sessionStorage.removeItem(TOKEN_KEY);
            document.documentElement.setAttribute('data-auth','locked');
            enforce();
          }
        };
      });
    })();
  </script>
</head>
<body>
  <div class="bg-fixed bg-lego"></div>

  <header class="nav-wrap container">
    <div class="nav panel">
      <div class="brand">
        <img class="brand-logo" src="./assets/images/ey.png" alt="EY Logo" />
        <span>GDS Consulting Visit Lego Blocks</span>
      </div>
      <ul class="menu">
        <li><a href="index.html#home">Home</a></li>
        <li>
          <a href="#settings" id="menuSettings">Settings ▾</a>
          <ul class="submenu">
            <li>
              <a href="lego-blocks.html" id="menuLegoBlocks" role="menuitem" style="display:block;padding:10px 12px;border-radius:8px">
                Lego Blocks
              </a>
            </li>
          </ul>
        </li>
        <li><a href="index.html#contact">Contact Us</a></li>
        <li><a href="#" id="logoutLink" style="display:none">Logout</a></li>
      </ul>
    </div>
  </header>

  <!-- APP (hidden until login + PAT) -->
  <div id="app" style="display:none">
    <main class="wrap" id="settings">
      <section class="panel hero hero-tight">
        <h1>Lego Blocks Settings</h1>
        <p>Manage records, tiers, links, and attachments for your visit building blocks.</p>
        <div class="toolbar row-actions">
          <input id="search" type="text" placeholder="Search records…" />
        </div>
      </section>

      <section class="panel adv">
        <div class="records-head">
          <div class="left">
            <div class="card-title">Records</div>
            <button class="btn btn-cta" id="openAddBtn">+ Add record</button>
          </div>
          <div class="right tiny-links">
            <a href="#" id="exportLink">Export</a>
            <a href="#" id="importLink">Import</a>
            <a href="#" id="clearAllLink">Clear All</a>
            <span class="count" id="countPill">0 records</span>
            <input type="file" id="csvFile" accept=".csv,text/csv" style="display:none" />
          </div>
        </div>

        <div class="card-body glass-inner">
          <div class="table-wrap">
            <table id="dataTable" aria-describedby="countPill">
              <thead>
                <tr>
                  <th class="cat">Category</th>
                  <th class="phase">Phase</th>
                  <th class="activity">Activity</th>
                  <th class="outcome">Key Outcome / Key Message</th>
                  <th class="tier-col">T1</th>
                  <th class="tier-col">T1.1</th>
                  <th class="tier-col">T1.2</th>
                  <th class="tier-col">T2</th>
                  <th class="tier-col">T2.1</th>
                  <th class="tier-col">T3</th>
                  <th class="tier-col">T3.1</th>
                  <th class="tier-col">T3.2</th>
                  <th class="actions">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="muted" style="margin-top:12px">
            Tip: You can download/upload multiple records at once. To upload, download this
            <a href="#" id="templateCsvLink">Import template.csv</a>
            and import using the links above.
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- LOGIN GATE -->
  <div id="gate" class="gate" aria-hidden="false">
    <div class="gate-card panel">
      <div class="gate-header">
        <h2>Admin Sign-in</h2>
        <p class="muted">Enter your admin credentials, then provide a GitHub token for saving.</p>
      </div>
      <div class="gate-form">
        <div class="field">
          <label for="gateUser">Username</label>
          <input id="gateUser" type="text" placeholder="Username" autocomplete="username" autofocus />
        </div>
        <div class="field">
          <label for="gatePass">Password</label>
          <input id="gatePass" type="password" placeholder="Password" autocomplete="current-password" />
        </div>

        <!-- Revealed ONLY after username/password are correct -->
        <div class="field" id="patRow" style="display:none">
          <label for="gatePat">GitHub PAT (Contents: read/write)</label>
          <input id="gatePat" type="password" placeholder="ghp_…" />
          <div class="muted" style="margin-top:6px">Token is kept for this tab until you close it.</div>
        </div>

        <div class="actions">
          <button type="button" class="btn btn-cta" id="gateEnter">Enter</button>
        </div>
        <div class="muted" id="gateError" style="display:none;color:#d33;margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- DETAILS modal -->
  <div class="modal-overlay" id="detailsOverlay" aria-hidden="true">
    <div class="modal panel" role="dialog" aria-modal="true" aria-labelledby="detailsTitle">
      <div class="modal-header">
        <div class="modal-title" id="detailsTitle">Record Details</div>
        <button class="btn btn-ghost" id="closeDetailsBtn">Close</button>
      </div>
      <div class="modal-body"><div id="detailsBody"></div></div>
      <div class="modal-footer">
        <button class="btn btn-ghost" id="detailsEditBtn">Edit</button>
        <button class="btn btn-danger" id="detailsDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit modal -->
  <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
    <div class="modal panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Add Record</div>
        <button class="btn btn-ghost" id="closeModalBtn">Close</button>
      </div>
      <form id="recordForm">
        <input type="hidden" id="recordId" />
        <div class="modal-body">
          <div class="section">
            <div class="section-title">Core Details</div>
            <div class="grid-3">
              <div>
                <label>Category<span class="req">*</span></label>
                <select id="category" required>
                  <option value="">— Select —</option>
                  <option>Preparation</option><option>Presentation</option><option>Group Meet</option>
                  <option>Experience</option><option>Collaboration</option><option>Post Event</option>
                </select>
              </div>
              <div>
                <label>Phase<span class="req">*</span></label>
                <select id="phase" required>
                  <option value="">— Select —</option>
                  <option>PRE</option><option>DURING</option><option>POST</option>
                </select>
              </div>
              <div>
                <label>Activity<span class="req">*</span></label>
                <input type="text" id="activity" placeholder="e.g., Welcome & Registration" required />
              </div>
              <div style="grid-column:1/-1">
                <label>Key Outcome / Key Message<span class="req">*</span></label>
                <textarea id="outcome" placeholder="What success looks like / key talking points" required></textarea>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Ownership</div>
            <div class="grid-3">
              <div>
                <label>Presentation Owner</label>
                <input type="text" id="presentationOwner" placeholder="Name / team" />
              </div>
              <div>
                <label>Content Owner</label>
                <input type="text" id="contentOwner" placeholder="Name / team" />
              </div>
              <div style="grid-column:1/-1">
                <label>Notes</label>
                <textarea id="notes" placeholder="Internal notes or reminders"></textarea>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Tiers<span class="req"> *</span></div>
            <div class="tier-grid">
              <div><label>Tier 1</label><select class="tier" id="tier_1" required></select></div>
              <div><label>Tier 1.1</label><select class="tier" id="tier_1_1" required></select></div>
              <div><label>Tier 1.2</label><select class="tier" id="tier_1_2" required></select></div>
              <div><label>Tier 2</label><select class="tier" id="tier_2" required></select></div>
              <div><label>Tier 2.1</label><select class="tier" id="tier_2_1" required></select></div>
              <div><label>Tier 3</label><select class="tier" id="tier_3" required></select></div>
              <div><label>Tier 3.1</label><select class="tier" id="tier_3_1" required></select></div>
              <div><label>Tier 3.2</label><select class="tier" id="tier_3_2" required></select></div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">URL / Links</div>
            <div id="linksContainer" class="links-container"></div>
            <div><button type="button" class="btn btn-ghost btn-sm" id="addLinkBtn">+ Add Link</button></div>
            <div class="muted">Label is what appears in the list.</div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" id="resetBtn">Reset</button>
          <button type="button" class="btn btn-danger" id="editDeleteBtn" style="display:none">Delete</button>
          <button type="submit" class="btn btn-cta" id="submitBtn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Base scripts (ORDER MATTERS) -->
  <script src="assets/js/script.js"></script>
  <script src="assets/js/storage-xml-github.js"></script>
  <script src="assets/js/lego-settings.js"></script>

  <!-- Safety net: if the external adapter didn't load, define it inline -->
  <script>
  (function(){
    if (window.XmlGitHubStorage) return; // external file loaded fine

    console.warn('[XmlGitHubStorage] Fallback inline adapter engaged (external script missing).');

    const OWNER  = 'markcolobong';
    const REPO   = 'cnslegoblocks';
    const BRANCH = 'main';
    const FILE_PATH = 'data/records.xml';

    const RAW_URL      = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${FILE_PATH}`;
    const CONTENTS_URL = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`;

    let GITHUB_TOKEN = null;

    function sanitizeToken(t){
      return (t||'').trim()
        .replace(/^[\"']+|[\"']+$/g,'')
        .replace(/\s+/g,'')
        .replace(/[\u200B-\u200D\uFEFF]/g,'');
    }
    async function ghFetch(url, init={}){
      const headers = Object.assign({
        'Accept': 'application/vnd.github+json',
        'X-GitHub-Api-Version': '2022-11-28'
      }, init.headers || {});
      const token = sanitizeToken(GITHUB_TOKEN || '');
      if (!token) return fetch(url, Object.assign({}, init, { headers }));
      let res = await fetch(url, Object.assign({}, init, { headers: Object.assign({}, headers, { Authorization: `token ${token}` }) }));
      if (res.status !== 401) return res;
      res = await fetch(url, Object.assign({}, init, { headers: Object.assign({}, headers, { Authorization: `Bearer ${token}` }) }));
      if (res.status !== 401) return res;
      return fetch(url, Object.assign({}, init, { headers: Object.assign({}, headers, { Authorization: 'Basic ' + btoa('x:' + token) }) }));
    }

    function cssEscape(s){ return String(s ?? '').replace(/"/g, '\\"'); }
    function base64EncodeUtf8(str){ return btoa(unescape(encodeURIComponent(str))); }
    function decodeBase64Utf8(b64){
      try { return decodeURIComponent(escape(atob(b64))); } catch { return ''; }
    }

    function parseXmlToRecords(xmlText){
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlText, 'application/xml');
      if (doc.querySelector('parsererror')) return [];
      const root = doc.querySelector('Records');
      if (!root) return [];

      const records = [];
      root.querySelectorAll('Record').forEach(node => {
        const text = tag => (node.querySelector(tag)?.textContent ?? '');
        const tier = name => {
          const el = node.querySelector(`Tiers > T[name="${cssEscape(name)}"]`);
          return el ? el.textContent : 'Applicable';
        };
        const id = node.getAttribute('id') || '';

        const links = [];
        node.querySelectorAll('Links > Link').forEach(L => {
          links.push({ label: L.getAttribute('label') || '', url: L.getAttribute('url') || '' });
        });

        records.push({
          id,
          category: text('Category'),
          phase: text('Phase'),
          activity: text('Activity'),
          outcome: text('Outcome'),
          presentationOwner: text('PresentationOwner'),
          contentOwner: text('ContentOwner'),
          notes: text('Notes'),
          links,
          tiers: {
            tier_1:  tier('tier_1'),
            tier_1_1:tier('tier_1_1'),
            tier_1_2:tier('tier_1_2'),
            tier_2:  tier('tier_2'),
            tier_2_1:tier('tier_2_1'),
            tier_3:  tier('tier_3'),
            tier_3_1:tier('tier_3_1'),
            tier_3_2:tier('tier_3_2')
          }
        });
      });
      return records;
    }

    function buildXml(records){
      const esc = s => String(s ?? '')
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
      const escAttr = s => String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;')
        .replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&apos;");

      const tier = (name, val) => `    <T name="${escAttr(name)}">${esc(val)}</T>\n`;
      const link = (l) => `    <Link label="${escAttr(l.label||'')}" url="${escAttr(l.url||'')}"/>\n`;

      let out = `<?xml version="1.0" encoding="UTF-8"?>\n<Records version="1">\n`;
      for (const r of records) {
        out += `  <Record id="${escAttr(r.id)}">\n`;
        out += `    <Category>${esc(r.category)}</Category>\n`;
        out += `    <Phase>${esc(r.phase)}</Phase>\n`;
        out += `    <Activity>${esc(r.activity)}</Activity>\n`;
        out += `    <Outcome>${esc(r.outcome)}</Outcome>\n`;
        out += `    <PresentationOwner>${esc(r.presentationOwner)}</PresentationOwner>\n`;
        out += `    <ContentOwner>${esc(r.contentOwner)}</ContentOwner>\n`;
        out += `    <Notes>${esc(r.notes)}</Notes>\n`;
        out += `    <Links>\n${(r.links||[]).map(link).join('')}    </Links>\n`;
        out += `    <Tiers>\n`;
        out += tier('tier_1',  r.tiers?.tier_1);
        out += tier('tier_1_1',r.tiers?.tier_1_1);
        out += tier('tier_1_2',r.tiers?.tier_1_2);
        out += tier('tier_2',  r.tiers?.tier_2);
        out += tier('tier_2_1',r.tiers?.tier_2_1);
        out += tier('tier_3',  r.tiers?.tier_3);
        out += tier('tier_3_1',r.tiers?.tier_3_1);
        out += tier('tier_3_2',r.tiers?.tier_3_2);
        out += `    </Tiers>\n`;
        out += `  </Record>\n`;
      }
      out += `</Records>\n`;
      return out;
    }

    async function getCurrentSha(){
      const res = await ghFetch(`${CONTENTS_URL}?ref=${encodeURIComponent(BRANCH)}`, { method: 'GET', cache:'no-store' });
      if (res.status === 200){
        const meta = await res.json();
        return meta.sha || null;
      }
      if (res.status === 404) return null;
      const t = await res.text();
      throw new Error('Failed reading file metadata: ' + t);
    }
    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    async function saveAllToGitHub(records, message){
      if (!GITHUB_TOKEN) throw new Error('Not authorized: missing GitHub token for write');

      const xml     = buildXml(records);
      const content = base64EncodeUtf8(xml);

      const MAX_TRIES = 4;
      for (let attempt = 1; attempt <= MAX_TRIES; attempt++){
        const sha = await getCurrentSha();

        const res = await ghFetch(CONTENTS_URL, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: message || 'Update data/records.xml',
            content,
            sha: sha || undefined,
            branch: BRANCH
          })
        });

        if (res.ok) return;

        let msg = '';
        try { msg = (await res.json())?.message || ''; } catch { try { msg = await res.text(); } catch {} }
        const isConflict = res.status === 409 || res.status === 422 || /does not match|sha/i.test(msg);
        if (isConflict && attempt < MAX_TRIES){
          await sleep(250 * attempt);
          continue;
        }
        throw new Error(msg || ('GitHub save failed ('+res.status+')'));
      }
    }

    const XmlGitHubStorage = {
      setToken(token){ GITHUB_TOKEN = sanitizeToken(token); },
      hasToken(){ return !!GITHUB_TOKEN; },

      async load(){
        try{
          if (GITHUB_TOKEN) {
            const res = await ghFetch(`${CONTENTS_URL}?ref=${encodeURIComponent(BRANCH)}`, { method: 'GET', cache:'no-store' });
            if (res.status === 404) return [];
            if (!res.ok) return [];
            const json = await res.json();
            const xmlText = decodeBase64Utf8((json.content || '').replace(/\n/g,''));
            return parseXmlToRecords(xmlText);
          }
          const res = await fetch(RAW_URL, { cache: 'no-store' });
          if(!res.ok) return [];
          const text = await res.text();
          return parseXmlToRecords(text);
        }catch{
          return [];
        }
      },

      async upsertOne(record){
        const all = await this.load();
        const idx = all.findIndex(r => r.id === record.id);
        if (idx >= 0) all[idx] = record; else all.push(record);
        await saveAllToGitHub(all, 'Upsert record from Lego Settings UI');
      },

      async updateOneById(record){
        if (!record?.id) throw new Error('Missing record id');
        const all = await this.load();
        const idx = all.findIndex(r => r.id === record.id);
        if (idx === -1) throw new Error('Record not found: ' + record.id);
        all[idx] = record;
        await saveAllToGitHub(all, 'Update record ' + record.id + ' from Lego Settings UI');
      },

      async replaceAll(records){
        await saveAllToGitHub(records, 'Replace all records from Lego Settings UI');
      },

      async deleteOne(id){
        const all = await this.load();
        const next = all.filter(r => r.id !== id);
        await saveAllToGitHub(next, 'Delete record from Lego Settings UI');
      }
    };

    window.XmlGitHubStorage = XmlGitHubStorage;
  })();
  </script>

  <!-- Block any legacy PAT prompt -->
  <script>
    (function(){
      const _prompt = window.prompt;
      window.prompt = function(msg, def){
        if (/(personal access token|pat|records\.xml)/i.test(String(msg||''))) return '';
        return _prompt ? _prompt(msg, def) : null;
      };
    })();
  </script>

  <!-- Login + PAT (STRICT: verify token with GitHub before unlock) -->
  <script>
  (function(){
    const OWNER='markcolobong', REPO='cnslegoblocks', BRANCH='main', PATH='data/records.xml';
    const CONTENTS_URL = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}?ref=${encodeURIComponent(BRANCH)}`;

    const SESSION_KEY='lego_admin_logged_in';
    const TOKEN_KEY='lego_admin_pat';

    const logout=document.getElementById('logoutLink');
    const uEl=document.getElementById('gateUser');
    const pEl=document.getElementById('gatePass');
    const patRow=document.getElementById('patRow');
    const patEl=document.getElementById('gatePat');
    const enterBtn=document.getElementById('gateEnter');
    const errBox=document.getElementById('gateError');

    if (enterBtn) enterBtn.setAttribute('type','button');

    function sanitizeToken(t){
      return (t||'').trim().replace(/^[\"']+|[\"']+$/g,'').replace(/\s+/g,'').replace(/[\u200B-\u200D\uFEFF]/g,'');
    }
    function showErr(m){ errBox.textContent=m; errBox.style.display=''; }
    function clearErr(){ errBox.textContent=''; errBox.style.display='none'; }

    async function verifyToken(pat){
      const headers = { 'X-GitHub-Api-Version':'2022-11-28' };
      try{
        let r = await fetch(CONTENTS_URL, { cache:'no-store', headers:{...headers, Authorization:`token ${pat}`} });
        if (r.status !== 401) return r.status;
        r = await fetch(CONTENTS_URL, { cache:'no-store', headers:{...headers, Authorization:`Bearer ${pat}`} });
        if (r.status !== 401) return r.status;
        r = await fetch(CONTENTS_URL, { cache:'no-store', headers:{...headers, Authorization:'Basic '+btoa('x:'+pat)} });
        return r.status;
      }catch{
        return 0;
      }
    }

    function unlockUI(pat){
      sessionStorage.setItem(TOKEN_KEY, pat);
      sessionStorage.setItem(SESSION_KEY, 'true');
      if (window.XmlGitHubStorage?.setToken) XmlGitHubStorage.setToken(pat);
      if (window.__authGuard?.unlock) __authGuard.unlock();
      else {
        document.documentElement.setAttribute('data-auth','unlocked');
        const app=document.getElementById('app'), gate=document.getElementById('gate');
        if (app) app.style.display=''; if (gate) gate.style.display='none';
      }
      if (logout) logout.style.display='';
      document.getElementById('openAddBtn')?.removeAttribute('disabled');
    }

    function lockUI(){
      sessionStorage.removeItem(SESSION_KEY);
      sessionStorage.removeItem(TOKEN_KEY);
      if (window.XmlGitHubStorage?.setToken) XmlGitHubStorage.setToken(null);
      if (window.__authGuard?.lock) __authGuard.lock();
      else {
        document.documentElement.setAttribute('data-auth','locked');
        const app=document.getElementById('app'), gate=document.getElementById('gate');
        if (app) app.style.display='none'; if (gate) gate.style.display='';
      }
      if (logout) logout.style.display='none';
    }

    let credsVerified=false, busy=false;

    (async function resume(){
      const logged = sessionStorage.getItem(SESSION_KEY)==='true';
      const tok = sessionStorage.getItem(TOKEN_KEY);
      if (logged && tok){
        const status = await verifyToken(tok);
        if (status===200 || status===404){
          unlockUI(tok);
          try{ await window.LegoSettings?.refresh?.(); }catch{}
        }else{
          lockUI();
        }
      }else{
        lockUI();
      }
    })();

    enterBtn?.addEventListener('click', async (e)=>{
      e.preventDefault();
      if (busy) return;
      clearErr();

      if (!credsVerified){
        const u=(uEl.value||'').trim();
        const p=(pEl.value||'').trim();
        if (u!=='admin' || p!=='+mark'){ showErr('Invalid credentials. Please try again.'); return; }
        credsVerified = true;
        patRow.style.display = '';
        enterBtn.textContent = 'Use Token';
        patEl.focus();
        return;
      }

      const pat = sanitizeToken(patEl.value);
      if (!pat){ showErr('Please enter a valid GitHub token.'); patEl.focus(); return; }

      const prev = enterBtn.textContent;
      busy = true; enterBtn.disabled = true; enterBtn.textContent = 'Validating…';

      const status = await verifyToken(pat);
      if (status===200 || status===404){
        unlockUI(pat);
        try{ await window.LegoSettings?.refresh?.(); }catch{}
      }else{
        showErr(status===401 ? 'Token rejected (401).'
              : status===403 ? 'Token lacks repo access (403).'
              : status===0   ? 'Network/CSP error contacting GitHub.'
                             : `Auth failed: ${status}`);
        lockUI();
      }
      busy = false; enterBtn.disabled = false; enterBtn.textContent = prev || 'Use Token';
    });

    logout?.addEventListener('click', (e)=>{
      e.preventDefault();
      lockUI();
      credsVerified=false;
      patRow.style.display='none';
      enterBtn.textContent='Enter';
      uEl.value=''; pEl.value=''; patEl.value='';
    });
  })();
  </script>

  <!-- Add Record glue (targeted edit by id + create) -->
  <script>
  (function(){
    const $ = (id) => document.getElementById(id);
    const appReady = () =>
      document.documentElement.getAttribute('data-auth') === 'unlocked' &&
      !!(window.XmlGitHubStorage?.hasToken && XmlGitHubStorage.hasToken());

    const addBtn   = $('openAddBtn');
    const overlay  = $('modalOverlay');
    const closeBtn = $('closeModalBtn');
    const form     = $('recordForm');
    const idInput  = $('recordId');

    function openModalForCreate(){
      if (!overlay || !form) return;
      form.reset();
      if (idInput) idInput.value = '';
      overlay.style.display = ''; // show
      overlay.setAttribute('aria-hidden','false');
    }
    function closeModal(){
      if (!overlay) return;
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden','true');
    }

    addBtn?.addEventListener('click', (e)=>{
      e.preventDefault();
      if (!appReady()){ alert('Please login with a valid GitHub token first.'); return; }
      openModalForCreate();
    });
    closeBtn?.addEventListener('click', (e)=>{ e.preventDefault(); closeModal(); });
    overlay?.addEventListener('click', (e)=>{ if (e.target === overlay) closeModal(); });

    if (form && !form.dataset.boundSave){
      form.dataset.boundSave = 'true';
      const val  = (id) => ($(id) ? $(id).value : '');
      const text = (id) => ($(id) ? $(id).value.trim() : '');

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (!window.XmlGitHubStorage?.upsertOne){
          alert('Write disabled: data adapter not loaded (XmlGitHubStorage).');
          return;
        }
        if (!XmlGitHubStorage.hasToken?.()){
          alert('Write disabled: please login with a valid GitHub token first.');
          return;
        }

        const record = {
          id: val('recordId') || ('r_' + Math.random().toString(36).slice(2) + Date.now().toString(36)),
          category: val('category'),
          phase: val('phase'),
          activity: text('activity'),
          outcome: text('outcome'),
          presentationOwner: text('presentationOwner'),
          contentOwner: text('contentOwner'),
          notes: text('notes'),
          links: Array.from(document.querySelectorAll('#linksContainer .link-row')).map(row => ({
            label: row.querySelector('.link-label')?.value || '',
            url:   row.querySelector('.link-url')?.value   || ''
          })),
          tiers: {
            tier_1:   val('tier_1'),
            tier_1_1: val('tier_1_1'),
            tier_1_2: val('tier_1_2'),
            tier_2:   val('tier_2'),
            tier_2_1: val('tier_2_1'),
            tier_3:   val('tier_3'),
            tier_3_1: val('tier_3_1'),
            tier_3_2: val('tier_3_2')
          }
        };

        if (!record.category || !record.phase || !record.activity || !record.outcome){
          alert('Please complete Category, Phase, Activity, and Outcome.');
          return;
        }

        const submitBtn = $('submitBtn');
        const prevLabel = submitBtn ? submitBtn.textContent : '';
        if (submitBtn){ submitBtn.disabled = true; submitBtn.textContent = 'Saving…'; }

        try{
          const isEdit = !!val('recordId');
          if (isEdit && XmlGitHubStorage.updateOneById){
            await XmlGitHubStorage.updateOneById(record);   // targeted update by id
          }else{
            await XmlGitHubStorage.upsertOne(record);       // create (or upsert)
          }
          if (idInput) idInput.value = record.id;
          try{ await window.LegoSettings?.refresh?.(); }catch{}
          closeModal();
        }catch(err){
          console.error(err);
          alert('Save failed: ' + (err?.message || err));
        }finally{
          if (submitBtn){ submitBtn.disabled = false; submitBtn.textContent = prevLabel || 'Save'; }
        }
      });

      const delBtn = $('editDeleteBtn');
      delBtn?.addEventListener('click', async ()=>{
        if (!XmlGitHubStorage.hasToken?.()){
          alert('Write disabled: please login with a valid GitHub token first.');
          return;
        }
        const id = (idInput ? idInput.value : '');
        if (!id){ alert('No record selected.'); return; }
        if (!confirm('Delete this record?')) return;

        try{
          await XmlGitHubStorage.deleteOne(id);
          try{ await window.LegoSettings?.refresh?.(); }catch{}
          form.reset();
          if (idInput) idInput.value = '';
          closeModal();
        }catch(err){
          console.error(err);
          alert('Delete failed: ' + (err?.message || err));
        }
      });
    }
  })();
  </script>

  <!-- Import handler (adds missing IDs, merges into XML, then refreshes UI) -->
  <script>
  (function(){
    const $ = (id) => document.getElementById(id);
    const importLink = $('importLink');
    const csvInput   = $('csvFile');

    function genId(){ return 'r_' + Math.random().toString(36).slice(2) + Date.now().toString(36); }

    // Tiny CSV cell parser with quotes support
    function splitCSVLine(line){
      const out=[], re=/("([^"]|"")*"|[^,]*)(,|$)/g; let m;
      while((m=re.exec(line))!==null){
        let cell=m[1] || '';
        if (cell.startsWith('"') && cell.endsWith('"')){
          cell = cell.slice(1,-1).replace(/""/g,'"');
        }
        out.push(cell.trim());
        if (m.index === re.lastIndex) re.lastIndex++;
      }
      return out;
    }

    function normalizeHeader(h){
      return String(h||'').toLowerCase().replace(/\s+/g,'').replace(/[^a-z0-9_]/g,'');
    }

    function toRecord(row, idxByName){
      const g = (name) => (row[idxByName[name]] ?? '').trim();

      // Links: link1_label/link1_url ... link10_label/link10_url
      const links = [];
      for (let n=1;n<=10;n++){
        const lbl = g(`link${n}label`) || g(`link${n}_label`);
        const url = g(`link${n}url`)   || g(`link${n}_url`);
        if (lbl || url) links.push({ label: lbl, url });
      }

      return {
        id: g('id') || genId(),
        category: g('category'),
        phase: g('phase'),
        activity: g('activity'),
        outcome: g('outcome'),
        presentationOwner: g('presentationowner'),
        contentOwner: g('contentowner'),
        notes: g('notes'),
        links,
        tiers: {
          tier_1:   g('tier1')   || g('tier_1'),
          tier_1_1: g('tier11')  || g('tier_1_1'),
          tier_1_2: g('tier12')  || g('tier_1_2'),
          tier_2:   g('tier2')   || g('tier_2'),
          tier_2_1: g('tier21')  || g('tier_2_1'),
          tier_3:   g('tier3')   || g('tier_3'),
          tier_3_1: g('tier31')  || g('tier_3_1'),
          tier_3_2: g('tier32')  || g('tier_3_2')
        }
      };
    }

    async function handleCSV(text){
      const lines = text.split(/\r?\n/).filter(l => l.trim().length>0);
      if (lines.length === 0) { alert('CSV is empty.'); return; }

      const headers = splitCSVLine(lines[0]).map(normalizeHeader);
      const idxByName = {};
      headers.forEach((h,i)=> idxByName[h]=i);

      const imported = [];
      for (let i=1;i<lines.length;i++){
        const row = splitCSVLine(lines[i]);
        if (row.every(c => String(c).trim()==='')) continue;
        imported.push(toRecord(row, idxByName));
      }
      if (!imported.length){ alert('No data rows found in CSV.'); return; }

      if (!window.XmlGitHubStorage?.hasToken?.()){
        alert('Write disabled: please login with a valid GitHub token first.');
        return;
      }

      const existing = await XmlGitHubStorage.load();
      const byId = new Map(existing.map(r => [r.id, r]));
      for (const rec of imported){
        // optional: skip if required fields missing
        if (!rec.category || !rec.phase || !rec.activity || !rec.outcome){
          console.warn('[import] Skipping row missing required fields:', rec);
          continue;
        }
        byId.set(rec.id, rec); // upsert by primary key
      }

      const merged = Array.from(byId.values());
      await XmlGitHubStorage.replaceAll(merged);

      try { await window.LegoSettings?.refresh?.(); } catch(e) { console.warn('refresh failed', e); }
      alert(`Imported ${imported.length} row(s).`);
    }

    importLink?.addEventListener('click', (e)=>{
      e.preventDefault();
      csvInput?.click();
    });
    csvInput?.addEventListener('change', ()=>{
      const f = csvInput.files && csvInput.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = async () => {
        try{ await handleCSV(String(reader.result||'')); }
        catch(err){ console.error(err); alert('Import failed: ' + (err?.message || err)); }
        finally { csvInput.value = ''; }
      };
      reader.readAsText(f);
    });
  })();
  </script>

  <!-- CSS note for modal visibility:
       .modal-overlay[aria-hidden="true"] { display:none; }
       .modal-overlay[aria-hidden="false"] { display:block; } /* or flex */
  -->
</body>
</html>
