<!-- Login + PAT on same card + session (STRICT: verify token before unlock) -->
<script>
(function(){
  // Repo to verify against
  const OWNER='markcolobong', REPO='cnslegoblocks', BRANCH='main', PATH='data/records.xml';
  const CONTENTS_URL = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}?ref=${encodeURIComponent(BRANCH)}`;

  // Session keys
  const SESSION_KEY='lego_admin_logged_in';
  const TOKEN_KEY='lego_admin_pat';

  // Gate elements
  const logout=document.getElementById('logoutLink');
  const uEl=document.getElementById('gateUser');
  const pEl=document.getElementById('gatePass');
  const patRow=document.getElementById('patRow');
  const patEl=document.getElementById('gatePat');
  const enterBtn=document.getElementById('gateEnter');
  const errBox=document.getElementById('gateError');

  // Ensure gate button never submits the form
  if (enterBtn) enterBtn.setAttribute('type','button');

  // Keep "+ Add record" disabled until unlocked + token present
  const addBtn = document.getElementById('openAddBtn');
  function syncAddBtnEnabled(){
    if (!addBtn) return;
    const unlocked = (document.documentElement.getAttribute('data-auth') === 'unlocked');
    const hasToken = (window.XmlGitHubStorage && XmlGitHubStorage.hasToken && XmlGitHubStorage.hasToken());
    addBtn.disabled = !(unlocked && hasToken);
  }
  setInterval(syncAddBtnEnabled, 500);

  // Utils
  function sanitizeToken(t){
    return (t||'').trim()
      .replace(/^[\"']+|[\"']+$/g,'')
      .replace(/\s+/g,'')
      .replace(/[\u200B-\u200D\uFEFF]/g,'');
  }
  function showErr(m){ errBox.textContent=m; errBox.style.display=''; }
  function clearErr(){ errBox.textContent=''; errBox.style.display='none'; }

  // Strict verify: try token → bearer → basic; success = 200 or 404 (file may not exist yet)
  async function verifyToken(pat){
    const headersBase = { 'X-GitHub-Api-Version':'2022-11-28' };
    try{
      let r = await fetch(CONTENTS_URL, { cache:'no-store', headers: { ...headersBase, Authorization:`token ${pat}` }});
      if (r.status !== 401) return r.status;
      r = await fetch(CONTENTS_URL, { cache:'no-store', headers: { ...headersBase, Authorization:`Bearer ${pat}` }});
      if (r.status !== 401) return r.status;
      r = await fetch(CONTENTS_URL, { cache:'no-store', headers: { ...headersBase, Authorization:'Basic '+btoa('x:'+pat) }});
      return r.status;
    }catch(e){
      console.error('verifyToken network error:', e);
      // Use 0 to indicate network/CSP error distinctly
      return 0;
    }
  }

  function unlockUI(pat){
    // Persist session + token
    sessionStorage.setItem(TOKEN_KEY, pat);
    sessionStorage.setItem(SESSION_KEY, 'true');

    // Wire token into storage
    if (window.XmlGitHubStorage && typeof XmlGitHubStorage.setToken === 'function'){
      XmlGitHubStorage.setToken(pat);
    }

    // Flip UI
    document.documentElement.setAttribute('data-auth','unlocked');
    const app=document.getElementById('app'), gate=document.getElementById('gate');
    if (app) app.style.display='';
    if (gate) gate.style.display='none';
    if (logout) logout.style.display='';
  }

  function lockUI(){
    sessionStorage.removeItem(SESSION_KEY);
    sessionStorage.removeItem(TOKEN_KEY);
    if (window.XmlGitHubStorage && typeof XmlGitHubStorage.setToken === 'function'){
      XmlGitHubStorage.setToken(null);
    }
    document.documentElement.setAttribute('data-auth','locked');
    const app=document.getElementById('app'), gate=document.getElementById('gate');
    if (app) app.style.display='none';
    if (gate) gate.style.display='';
    if (logout) logout.style.display='none';
  }

  let credsVerified=false, busy=false;

  // Resume ONLY if token still verifies
  (async function resume(){
    const logged = sessionStorage.getItem(SESSION_KEY)==='true';
    const tok = sessionStorage.getItem(TOKEN_KEY);
    if (logged && tok){
      const status = await verifyToken(tok);
      if (status===200 || status===404){
        unlockUI(tok);
        try{ if (window.LegoSettings?.refresh) await LegoSettings.refresh(); }catch{}
      }else{
        // Token no longer valid → hard lock
        lockUI();
      }
    }else{
      lockUI();
    }
  })();

  // Main click: Step 1 user/pass, Step 2 verify PAT then unlock
  enterBtn?.addEventListener('click', async (e)=>{
    e.preventDefault();
    if (busy) return;
    clearErr();

    // STEP 1 — user/pass
    if (!credsVerified){
      const u=(uEl.value||'').trim();
      const p=(pEl.value||'').trim();
      if (u!=='admin' || p!=='+mark'){
        showErr('Invalid credentials. Please try again.');
        return;
      }
      credsVerified = true;
      patRow.style.display = '';
      enterBtn.textContent = 'Use Token';
      patEl.focus();
      return;
    }

    // STEP 2 — verify PAT against repo
    const pat = sanitizeToken(patEl.value);
    if (!pat){ showErr('Please enter a valid GitHub token.'); patEl.focus(); return; }

    const prevLabel = enterBtn.textContent;
    busy = true;
    enterBtn.disabled = true;
    enterBtn.textContent = 'Validating…';

    const status = await verifyToken(pat);

    if (status===200 || status===404){
      // Success → unlock
      unlockUI(pat);
      try{ if (window.LegoSettings?.refresh) await LegoSettings.refresh(); }catch{}
      // restore button
      enterBtn.disabled = false;
      enterBtn.textContent = prevLabel || 'Use Token';
      busy = false;
      syncAddBtnEnabled();
      return;
    }

    // Fail → stay on gate, show reason
    let msg = 'Token validation failed.';
    if (status===401) msg = 'Token rejected (401).';
    else if (status===403) msg = 'Token lacks access to this repo (403).';
    else if (status===0) msg = 'Network/CSP error contacting GitHub. Check connectivity/VPN/Adblock.';
    else msg = `Auth failed: ${status}`;
    showErr(msg);

    // restore button and keep locked
    enterBtn.disabled = false;
    enterBtn.textContent = prevLabel || 'Use Token';
    busy = false;
    lockUI();
  });

  // Logout
  logout?.addEventListener('click', (e)=>{
    e.preventDefault();
    lockUI();
    // Reset gate form
    credsVerified=false;
    patRow.style.display='none';
    enterBtn.textContent='Enter';
    uEl.value=''; pEl.value=''; patEl.value='';
    syncAddBtnEnabled();
  });
})();
</script>
