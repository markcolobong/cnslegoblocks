<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lego Blocks Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="assets/css/lego-settings.css" />

  <!-- HARD GATE GUARD: prevents any script from showing #app before auth -->
  <script>
    (function(){
      const SESSION_KEY='lego_admin_logged_in';
      const TOKEN_KEY='lego_admin_pat';

      // never allow app visible at load
      document.documentElement.setAttribute('data-auth', 'locked');

      // after DOM is ready, enforce visibility until unlocked
      document.addEventListener('DOMContentLoaded', () => {
        const app = document.getElementById('app');
        const gate = document.getElementById('gate');

        function locked(){ return !(sessionStorage.getItem(SESSION_KEY)==='true' && sessionStorage.getItem(TOKEN_KEY)); }

        function enforce(){
          if (!app || !gate) return;
          if (locked()){
            app.style.display = 'none';
            gate.style.display = '';
          }
        }
        enforce();

        // MutationObserver: if any script tries to show the app while locked, hide it back
        const mo = new MutationObserver(enforce);
        mo.observe(document.body, { attributes:true, childList:true, subtree:true });

        // Expose unlock/lock helpers used by the login script below
        window.__authGuard = {
          unlock(){
            sessionStorage.setItem(SESSION_KEY,'true');
            document.documentElement.setAttribute('data-auth', 'unlocked');
            mo.disconnect(); // stop enforcing once unlocked
            if (app) app.style.display = '';
            if (gate) gate.style.display = 'none';
          },
          lock(){
            sessionStorage.removeItem(SESSION_KEY);
            sessionStorage.removeItem(TOKEN_KEY);
            document.documentElement.setAttribute('data-auth', 'locked');
            enforce();
          }
        };
      });
    })();
  </script>
</head>
<body>
  <div class="bg-fixed bg-lego"></div>

  <header class="nav-wrap container">
    <div class="nav panel">
      <div class="brand">
        <img class="brand-logo" src="./assets/images/ey.png" alt="EY Logo" />
        <span>GDS Consulting Visit Lego Blocks</span>
      </div>
      <ul class="menu">
        <li><a href="index.html#home">Home</a></li>
        <li>
          <a href="#settings" id="menuSettings">Settings ▾</a>
          <ul class="submenu">
            <li>
              <a href="lego-blocks.html" id="menuLegoBlocks" role="menuitem" style="display:block;padding:10px 12px;border-radius:8px">
                Lego Blocks
              </a>
            </li>
          </ul>
        </li>
        <li><a href="index.html#contact">Contact Us</a></li>
        <li><a href="#" id="logoutLink" style="display:none">Logout</a></li>
      </ul>
    </div>
  </header>

  <!-- APP (hidden by guard until login + PAT) -->
  <div id="app" style="display:none">
    <main class="wrap" id="settings">
      <section class="panel hero hero-tight">
        <h1>Lego Blocks Settings</h1>
        <p>Manage records, tiers, links, and attachments for your visit building blocks.</p>
        <div class="toolbar row-actions">
          <input id="search" type="text" placeholder="Search records…" />
        </div>
      </section>

      <section class="panel adv">
        <div class="records-head">
          <div class="left">
            <div class="card-title">Records</div>
            <button class="btn btn-cta" id="openAddBtn">+ Add record</button>
          </div>
          <div class="right tiny-links">
            <a href="#" id="exportLink">Export</a>
            <a href="#" id="importLink">Import</a>
            <a href="#" id="clearAllLink">Clear All</a>
            <span class="count" id="countPill">0 records</span>
            <input type="file" id="csvFile" accept=".csv,text/csv" style="display:none" />
          </div>
        </div>

        <div class="card-body glass-inner">
          <div class="table-wrap">
            <table id="dataTable" aria-describedby="countPill">
              <thead>
                <tr>
                  <th class="cat">Category</th>
                  <th class="phase">Phase</th>
                  <th class="activity">Activity</th>
                  <th class="outcome">Key Outcome / Key Message</th>
                  <th class="tier-col">T1</th>
                  <th class="tier-col">T1.1</th>
                  <th class="tier-col">T1.2</th>
                  <th class="tier-col">T2</th>
                  <th class="tier-col">T2.1</th>
                  <th class="tier-col">T3</th>
                  <th class="tier-col">T3.1</th>
                  <th class="tier-col">T3.2</th>
                  <th class="actions">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="muted" style="margin-top:12px">
            Tip: You can download/upload multiple records at once. To upload, download this
            <a href="#" id="templateCsvLink">Import template.csv</a>
            and import using the links above.
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- LOGIN GATE -->
  <div id="gate" class="gate" aria-hidden="false">
    <div class="gate-card panel">
      <div class="gate-header">
        <h2>Admin Sign-in</h2>
        <p class="muted">Enter your admin credentials, then provide a GitHub token for saving.</p>
      </div>
      <div class="gate-form">
        <div class="field">
          <label for="gateUser">Username</label>
          <input id="gateUser" type="text" placeholder="Username" autocomplete="username" autofocus />
        </div>
        <div class="field">
          <label for="gatePass">Password</label>
          <input id="gatePass" type="password" placeholder="Password" autocomplete="current-password" />
        </div>

        <!-- Revealed ONLY after username/password are correct -->
        <div class="field" id="patRow" style="display:none">
          <label for="gatePat">GitHub PAT (Contents: read/write)</label>
          <input id="gatePat" type="password" placeholder="ghp_…" />
          <div class="muted" style="margin-top:6px">Token is kept for this tab until you close it.</div>
        </div>

        <div class="actions">
          <button class="btn btn-cta" id="gateEnter">Enter</button>
        </div>
        <div class="muted" id="gateError" style="display:none;color:#d33;margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- (Your existing details/add/edit modals remain unchanged below) -->

  <script src="assets/js/script.js"></script>
  <script src="assets/js/storage-xml-github.js"></script>

  <!-- Suppress any legacy prompt asking for PAT -->
  <script>
    (function(){
      const _prompt = window.prompt;
      window.prompt = function(msg, def){
        if (/(personal access token|pat|records\.xml)/i.test(String(msg||''))) return '';
        return _prompt ? _prompt(msg, def) : null;
      };
    })();
  </script>

  <script src="assets/js/lego-settings.js"></script>

  <!-- LOGIN FLOW (PAT field on same card; hard gate unlocks only after both steps) -->
  <script>
  (function(){
    const OWNER='markcolobong', REPO='cnslegoblocks', BRANCH='main', PATH='data/records.xml';
    const SESSION_KEY='lego_admin_logged_in';
    const TOKEN_KEY='lego_admin_pat';

    const gate=document.getElementById('gate');
    const app=document.getElementById('app');
    const logout=document.getElementById('logoutLink');
    const uEl=document.getElementById('gateUser');
    const pEl=document.getElementById('gatePass');
    const patRow=document.getElementById('patRow');
    const patEl=document.getElementById('gatePat');
    const enterBtn=document.getElementById('gateEnter');
    const errBox=document.getElementById('gateError');

    let credsVerified=false;

    function sanitizeToken(t){
      return (t||'').trim()
        .replace(/^[\"']+|[\"']+$/g,'')
        .replace(/\s+/g,'')
        .replace(/[\u200B-\u200D\uFEFF]/g,'');
    }
    function showErr(m){ errBox.textContent=m; errBox.style.display=''; }
    function clearErr(){ errBox.textContent=''; errBox.style.display='none'; }
    function show(el){ el.style.display=''; el.setAttribute('aria-hidden','false'); }
    function hide(el){ el.style.display='none'; el.setAttribute('aria-hidden','true'); }

    async function probeRepo(pat){
      const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}?ref=${encodeURIComponent(BRANCH)}`;
      let r = await fetch(url, { headers: { 'X-GitHub-Api-Version':'2022-11-28', Authorization:`token ${pat}` }});
      if (r.status===401) r = await fetch(url, { headers: { 'X-GitHub-Api-Version':'2022-11-28', Authorization:`Bearer ${pat}` }});
      if (r.status===401) r = await fetch(url, { headers: { 'X-GitHub-Api-Version':'2022-11-28', Authorization:'Basic '+btoa('x:'+pat) }});
      return r.status;
    }

    // Resume only if token + login present; otherwise keep gate shown (guard also enforces)
    (async function resume(){
      const logged = sessionStorage.getItem(SESSION_KEY)==='true';
      const tok = sessionStorage.getItem(TOKEN_KEY);
      if (logged && tok){
        XmlGitHubStorage.setToken(tok);
        if (window.__authGuard) window.__authGuard.unlock();
        logout.style.display='';
        try{ await LegoSettings?.refresh?.(); }catch{}
      }else{
        if (window.__authGuard) window.__authGuard.lock();
      }
    })();

    enterBtn?.addEventListener('click', async ()=>{
      clearErr();

      if (!credsVerified){
        const u=(uEl.value||'').trim();
        const p=(pEl.value||'').trim();
        if (u!=='admin' || p!=='+mark'){ showErr('Invalid credentials. Please try again.'); return; }
        credsVerified=true;
        show(patRow);
        enterBtn.textContent='Use Token';
        patEl.focus();
        return;
      }

      const pat = sanitizeToken(patEl.value);
      if (!pat){ showErr('Please enter a valid GitHub token.'); patEl.focus(); return; }

      const status = await probeRepo(pat);
      if (status!==200 && status!==404){
        showErr(status===401 ? 'Token rejected (401).' : (status===403 ? 'Token lacks access (403).' : ('Auth failed: '+status)));
        return;
      }

      sessionStorage.setItem(SESSION_KEY,'true');
      sessionStorage.setItem(TOKEN_KEY, pat);
      XmlGitHubStorage.setToken(pat);

      if (window.__authGuard) window.__authGuard.unlock();
      logout.style.display='';
      try{ await LegoSettings?.refresh?.(); }catch{}
    });

    // Logout clears everything and re-locks
    logout?.addEventListener('click', (e)=>{
      e.preventDefault();
      sessionStorage.removeItem(SESSION_KEY);
      sessionStorage.removeItem(TOKEN_KEY);
      XmlGitHubStorage.setToken(null);
      if (window.__authGuard) window.__authGuard.lock();
      logout.style.display='none';
      // reset gate state
      credsVerified=false;
      hide(patRow);
      enterBtn.textContent='Enter';
      uEl.value=''; pEl.value=''; patEl.value='';
    });
  })();
  </script>
</body>
</html>
