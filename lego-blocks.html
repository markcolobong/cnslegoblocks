<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lego Blocks Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="assets/css/lego-settings.css" />
</head>
<body>
  <div class="bg-fixed bg-lego"></div>

  <header class="nav-wrap container">
    <div class="nav panel">
      <div class="brand">
        <img class="brand-logo" src="./assets/images/ey.png" alt="EY Logo" />
        <span>GDS Consulting Visit Lego Blocks</span>
      </div>
      <ul class="menu">
        <li><a href="index.html#home">Home</a></li>
        <li>
          <a href="#settings" id="menuSettings">Settings ▾</a>
          <ul class="submenu">
            <li>
              <a href="lego-blocks.html" id="menuLegoBlocks" role="menuitem" style="display:block;padding:10px 12px;border-radius:8px">
                Lego Blocks
              </a>
            </li>
          </ul>
        </li>
        <li><a href="index.html#contact">Contact Us</a></li>
      </ul>
    </div>
  </header>

  <div id="app" style="display:none">
    <main class="wrap" id="settings">
      <section class="panel hero hero-tight">
        <h1>Lego Blocks Settings</h1>
        <p>Manage records, tiers, links, and attachments for your visit building blocks.</p>
        <div class="toolbar row-actions">
          <input id="search" type="text" placeholder="Search records…" />
        </div>
      </section>

      <section class="panel adv">
        <div class="records-head">
          <div class="left">
            <div class="card-title">Records</div>
            <button class="btn btn-cta" id="openAddBtn">+ Add record</button>
          </div>
          <div class="right tiny-links">
            <a href="#" id="exportLink">Export</a>
            <a href="#" id="importLink">Import</a>
            <a href="#" id="clearAllLink">Clear All</a>
            <span class="count" id="countPill">0 records</span>
            <input type="file" id="csvFile" accept=".csv,text/csv" style="display:none" />
          </div>
        </div>

        <div class="card-body glass-inner">
          <div class="table-wrap">
            <table id="dataTable" aria-describedby="countPill">
              <thead>
                <tr>
                  <th class="cat">Category</th>
                  <th class="phase">Phase</th>
                  <th class="activity">Activity</th>
                  <th class="outcome">Key Outcome / Key Message</th>
                  <th class="tier-col">T1</th>
                  <th class="tier-col">T1.1</th>
                  <th class="tier-col">T1.2</th>
                  <th class="tier-col">T2</th>
                  <th class="tier-col">T2.1</th>
                  <th class="tier-col">T3</th>
                  <th class="tier-col">T3.1</th>
                  <th class="tier-col">T3.2</th>
                  <th class="actions">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="muted" style="margin-top:12px">
            Tip: You can download/upload multiple records at once. To upload, download this
            <a href="#" id="templateCsvLink">Import template.csv</a>
            and import using the links above.
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="gate" class="gate" aria-hidden="false">
    <div class="gate-card panel">
      <div class="gate-header">
        <h2>Admin Sign-in</h2>
        <p class="muted">Paste your GitHub <em>Personal Access Token</em> in the Password field.</p>
      </div>
      <div class="gate-form">
        <div class="field">
          <label for="gateUser">Username</label>
          <input id="gateUser" type="text" placeholder="Username" autocomplete="username" autofocus />
        </div>
        <div class="field">
          <label for="gatePass">Password (GitHub PAT)</label>
          <input id="gatePass" type="password" placeholder="GitHub PAT" autocomplete="current-password" />
        </div>
        <div class="actions">
          <button class="btn btn-cta" id="gateEnter">Enter</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="detailsOverlay" aria-hidden="true">
    <div class="modal panel" role="dialog" aria-modal="true" aria-labelledby="detailsTitle">
      <div class="modal-header">
        <div class="modal-title" id="detailsTitle">Record Details</div>
        <button class="btn btn-ghost" id="closeDetailsBtn">Close</button>
      </div>
      <div class="modal-body"><div id="detailsBody"></div></div>
      <div class="modal-footer">
        <button class="btn btn-ghost" id="detailsEditBtn">Edit</button>
        <button class="btn btn-danger" id="detailsDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
    <div class="modal panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Add Record</div>
        <button class="btn btn-ghost" id="closeModalBtn">Close</button>
      </div>

      <form id="recordForm">
        <input type="hidden" id="recordId" />
        <div class="modal-body">
          <div class="section">
            <div class="section-title">Core Details</div>
            <div class="grid-3">
              <div>
                <label>Category<span class="req">*</span></label>
                <select id="category" required>
                  <option value="">— Select —</option>
                  <option>Preparation</option><option>Presentation</option><option>Group Meet</option>
                  <option>Experience</option><option>Collaboration</option><option>Post Event</option>
                </select>
              </div>
              <div>
                <label>Phase<span class="req">*</span></label>
                <select id="phase" required>
                  <option value="">— Select —</option>
                  <option>PRE</option><option>DURING</option><option>POST</option>
                </select>
              </div>
              <div>
                <label>Activity<span class="req">*</span></label>
                <input type="text" id="activity" placeholder="e.g., Welcome & Registration" required />
              </div>
              <div style="grid-column:1/-1">
                <label>Key Outcome / Key Message<span class="req">*</span></label>
                <textarea id="outcome" placeholder="What success looks like / key talking points" required></textarea>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Ownership</div>
            <div class="grid-3">
              <div>
                <label>Presentation Owner</label>
                <input type="text" id="presentationOwner" placeholder="Name / team" />
              </div>
              <div>
                <label>Content Owner</label>
                <input type="text" id="contentOwner" placeholder="Name / team" />
              </div>
              <div style="grid-column:1/-1">
                <label>Notes</label>
                <textarea id="notes" placeholder="Internal notes or reminders"></textarea>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Tiers<span class="req"> *</span></div>
            <div class="tier-grid">
              <div><label>Tier 1</label><select class="tier" id="tier_1" required></select></div>
              <div><label>Tier 1.1</label><select class="tier" id="tier_1_1" required></select></div>
              <div><label>Tier 1.2</label><select class="tier" id="tier_1_2" required></select></div>
              <div><label>Tier 2</label><select class="tier" id="tier_2" required></select></div>
              <div><label>Tier 2.1</label><select class="tier" id="tier_2_1" required></select></div>
              <div><label>Tier 3</label><select class="tier" id="tier_3" required></select></div>
              <div><label>Tier 3.1</label><select class="tier" id="tier_3_1" required></select></div>
              <div><label>Tier 3.2</label><select class="tier" id="tier_3_2" required></select></div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">URL / Links</div>
            <div id="linksContainer" class="links-container"></div>
            <div><button type="button" class="btn btn-ghost btn-sm" id="addLinkBtn">+ Add Link</button></div>
            <div class="muted">Label is what appears in the list.</div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" id="resetBtn">Reset</button>
          <button type="button" class="btn btn-danger" id="editDeleteBtn" style="display:none">Delete</button>
          <button type="submit" class="btn btn-cta" id="submitBtn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script src="assets/js/script.js"></script>
  <script src="assets/js/storage-xml-github.js"></script>
  <script src="assets/js/lego-settings.js"></script>

  <script>
  (function(){
    const OWNER  = 'markcolobong';
    const REPO   = 'cnslegoblocks';
    const BRANCH = 'main';
    const FILE_PATH = 'data/records.xml';

    const gate = document.getElementById('gate');
    const app  = document.getElementById('app');

    function sanitizeToken(t){
      return (t||'')
        .trim()
        .replace(/\s+/g,'')           // remove spaces/newlines
        .replace(/[\u200B-\u200D]/g,'')// zero-width spaces
        .replace(/[\uFEFF]/g,'');      // BOM
    }

    document.getElementById('gateEnter')?.addEventListener('click', async () => {
      let pat = sanitizeToken(document.getElementById('gatePass')?.value);
      if (!pat){ alert('Paste your GitHub token in the Password field.'); return; }
      if (!window.XmlGitHubStorage){ alert('XmlGitHubStorage not loaded.'); return; }

      XmlGitHubStorage.setToken(pat);

      const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}?ref=${encodeURIComponent(BRANCH)}`;
      const r = await fetch(url, { headers: { Authorization: `token ${pat}`, 'X-GitHub-Api-Version':'2022-11-28' } })
        .then(async res => {
          if (res.status !== 401) return res;
          // fallback auth schemes
          let retry = await fetch(url, { headers: { Authorization: `Bearer ${pat}`, 'X-GitHub-Api-Version':'2022-11-28' } });
          if (retry.status !== 401) return retry;
          const basic = 'Basic ' + btoa('x:' + pat);
          return fetch(url, { headers: { Authorization: basic, 'X-GitHub-Api-Version':'2022-11-28' } });
        });

      if (r.status === 200 || r.status === 404){
        gate.style.display = 'none';
        app.style.display  = '';
        if (window.LegoSettings?.refresh) { try { await LegoSettings.refresh(); } catch {} }
      } else if (r.status === 401){
        alert('401 Bad credentials. Recreate your token (fine-grained: Contents Read/Write for this repo, or classic ghp_ with repo scope).');
      } else if (r.status === 403){
        alert('403 Forbidden: token lacks Contents access to this repo.');
      } else {
        alert('Auth failed: ' + r.status + ' ' + (await r.text()));
      }
    });

    const form = document.getElementById('recordForm');
    const submitBtn = document.getElementById('submitBtn');

    function rid(){ return 'r_' + Math.random().toString(36).slice(2) + Date.now().toString(36); }

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!window.XmlGitHubStorage){ alert('XmlGitHubStorage not loaded.'); return; }

      const record = {
        id: document.getElementById('recordId').value || rid(),
        category: document.getElementById('category').value,
        phase: document.getElementById('phase').value,
        activity: document.getElementById('activity').value,
        outcome: document.getElementById('outcome').value,
        presentationOwner: document.getElementById('presentationOwner').value,
        contentOwner: document.getElementById('contentOwner').value,
        notes: document.getElementById('notes').value,
        links: Array.from(document.querySelectorAll('#linksContainer .link-row')).map(row => ({
          label: row.querySelector('.link-label')?.value || '',
          url:   row.querySelector('.link-url')?.value   || ''
        })),
        tiers: {
          tier_1:  document.getElementById('tier_1').value,
          tier_1_1:document.getElementById('tier_1_1').value,
          tier_1_2:document.getElementById('tier_1_2').value,
          tier_2:  document.getElementById('tier_2').value,
          tier_2_1:document.getElementById('tier_2_1').value,
          tier_3:  document.getElementById('tier_3').value,
          tier_3_1:document.getElementById('tier_3_1').value,
          tier_3_2:document.getElementById('tier_3_2').value
        }
      };

      submitBtn.disabled = true; submitBtn.textContent = 'Saving…';
      try{
        await XmlGitHubStorage.upsertOne(record);
        alert('Saved to GitHub XML');
        if (window.LegoSettings?.refresh) { await LegoSettings.refresh(); }
        document.getElementById('recordId').value = record.id;
      }catch(err){
        alert('Save failed: ' + (err?.message || err));
      }finally{
        submitBtn.disabled = false; submitBtn.textContent = 'Save';
      }
    });

    const delBtn = document.getElementById('editDeleteBtn');
    delBtn?.addEventListener('click', async () => {
      const id = document.getElementById('recordId').value;
      if (!id){ alert('No record id.'); return; }
      if (!confirm('Delete this record?')) return;

      try{
        await XmlGitHubStorage.deleteOne(id);
        alert('Deleted from GitHub XML');
        if (window.LegoSettings?.refresh) { await LegoSettings.refresh(); }
        document.getElementById('recordForm').reset();
        document.getElementById('recordId').value = '';
      }catch(err){
        alert('Delete failed: ' + (err?.message || err));
      }
    });
  })();
  </script>
</body>
</html>
