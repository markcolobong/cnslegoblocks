<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lego Blocks Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="assets/css/lego-settings.css" />

  <!-- HARD GATE: keep app hidden until session + token -->
  <script>
    (function(){
      const SESSION_KEY='lego_admin_logged_in';
      const TOKEN_KEY='lego_admin_pat';
      document.documentElement.setAttribute('data-auth','locked');

      document.addEventListener('DOMContentLoaded', () => {
        const app  = document.getElementById('app');
        const gate = document.getElementById('gate');
        function locked(){
          return !(sessionStorage.getItem(SESSION_KEY)==='true' && sessionStorage.getItem(TOKEN_KEY));
        }
        function enforce(){
          if (!app || !gate) return;
          if (locked()){ app.style.display='none'; gate.style.display=''; }
        }
        enforce();
        const mo = new MutationObserver(enforce);
        mo.observe(document.body, { attributes:true, childList:true, subtree:true });

        window.__authGuard = {
          unlock(){
            sessionStorage.setItem(SESSION_KEY,'true');
            document.documentElement.setAttribute('data-auth','unlocked');
            mo.disconnect();
            if (app) app.style.display='';
            if (gate) gate.style.display='none';
          },
          lock(){
            sessionStorage.removeItem(SESSION_KEY);
            sessionStorage.removeItem(TOKEN_KEY);
            document.documentElement.setAttribute('data-auth','locked');
            enforce();
          }
        };
      });
    })();
  </script>
</head>
<body>
  <div class="bg-fixed bg-lego"></div>

  <header class="nav-wrap container">
    <div class="nav panel">
      <div class="brand">
        <img class="brand-logo" src="./assets/images/ey.png" alt="EY Logo" />
        <span>GDS Consulting Visit Lego Blocks</span>
      </div>
      <ul class="menu">
        <li><a href="index.html#home">Home</a></li>
        <li>
          <a href="#settings" id="menuSettings">Settings ▾</a>
          <ul class="submenu">
            <li>
              <a href="lego-blocks.html" id="menuLegoBlocks" role="menuitem" style="display:block;padding:10px 12px;border-radius:8px">
                Lego Blocks
              </a>
            </li>
          </ul>
        </li>
        <li><a href="index.html#contact">Contact Us</a></li>
        <li><a href="#" id="logoutLink" style="display:none">Logout</a></li>
      </ul>
    </div>
  </header>

  <!-- APP (hidden until login + PAT) -->
  <div id="app" style="display:none">
    <main class="wrap" id="settings">
      <section class="panel hero hero-tight">
        <h1>Lego Blocks Settings</h1>
        <p>Manage records, tiers, links, and attachments for your visit building blocks.</p>
        <div class="toolbar row-actions">
          <input id="search" type="text" placeholder="Search records…" />
        </div>
      </section>

      <section class="panel adv">
        <div class="records-head">
          <div class="left">
            <div class="card-title">Records</div>
            <button class="btn btn-cta" id="openAddBtn">+ Add record</button>
          </div>
          <div class="right tiny-links">
            <a href="#" id="exportLink">Export</a>
            <a href="#" id="importLink">Import</a>
            <a href="#" id="clearAllLink">Clear All</a>
            <span class="count" id="countPill">0 records</span>
            <input type="file" id="csvFile" accept=".csv,text/csv" style="display:none" />
          </div>
        </div>

        <div class="card-body glass-inner">
          <div class="table-wrap">
            <table id="dataTable" aria-describedby="countPill">
              <thead>
                <tr>
                  <th class="cat">Category</th>
                  <th class="phase">Phase</th>
                  <th class="activity">Activity</th>
                  <th class="outcome">Key Outcome / Key Message</th>
                  <th class="tier-col">T1</th>
                  <th class="tier-col">T1.1</th>
                  <th class="tier-col">T1.2</th>
                  <th class="tier-col">T2</th>
                  <th class="tier-col">T2.1</th>
                  <th class="tier-col">T3</th>
                  <th class="tier-col">T3.1</th>
                  <th class="tier-col">T3.2</th>
                  <th class="actions">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="muted" style="margin-top:12px">
            Tip: You can download/upload multiple records at once. To upload, download this
            <a href="#" id="templateCsvLink">Import template.csv</a>
            and import using the links above.
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- LOGIN GATE -->
  <div id="gate" class="gate" aria-hidden="false">
    <div class="gate-card panel">
      <div class="gate-header">
        <h2>Admin Sign-in</h2>
        <p class="muted">Enter your admin credentials, then provide a GitHub token for saving.</p>
      </div>
      <div class="gate-form">
        <div class="field">
          <label for="gateUser">Username</label>
          <input id="gateUser" type="text" placeholder="Username" autocomplete="username" autofocus />
        </div>
        <div class="field">
          <label for="gatePass">Password</label>
          <input id="gatePass" type="password" placeholder="Password" autocomplete="current-password" />
        </div>

        <!-- Revealed ONLY after username/password are correct -->
        <div class="field" id="patRow" style="display:none">
          <label for="gatePat">GitHub PAT (Contents: read/write)</label>
          <input id="gatePat" type="password" placeholder="ghp_…" />
          <div class="muted" style="margin-top:6px">Token is kept for this tab until you close it.</div>
        </div>

        <div class="actions">
          <button type="button" class="btn btn-cta" id="gateEnter">Enter</button>
        </div>
        <div class="muted" id="gateError" style="display:none;color:#d33;margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- DETAILS modal -->
  <div class="modal-overlay" id="detailsOverlay" aria-hidden="true">
    <div class="modal panel" role="dialog" aria-modal="true" aria-labelledby="detailsTitle">
      <div class="modal-header">
        <div class="modal-title" id="detailsTitle">Record Details</div>
        <button class="btn btn-ghost" id="closeDetailsBtn">Close</button>
      </div>
      <div class="modal-body"><div id="detailsBody"></div></div>
      <div class="modal-footer">
        <button class="btn btn-ghost" id="detailsEditBtn">Edit</button>
        <button class="btn btn-danger" id="detailsDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit modal -->
  <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
    <div class="modal panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Add Record</div>
        <button class="btn btn-ghost" id="closeModalBtn">Close</button>
      </div>
      <form id="recordForm">
        <input type="hidden" id="recordId" />
        <div class="modal-body">
          <div class="section">
            <div class="section-title">Core Details</div>
            <div class="grid-3">
              <div>
                <label>Category<span class="req">*</span></label>
                <select id="category" required>
                  <option value="">— Select —</option>
                  <option>Preparation</option><option>Presentation</option><option>Group Meet</option>
                  <option>Experience</option><option>Collaboration</option><option>Post Event</option>
                </select>
              </div>
              <div>
                <label>Phase<span class="req">*</span></label>
                <select id="phase" required>
                  <option value="">— Select —</option>
                  <option>PRE</option><option>DURING</option><option>POST</option>
                </select>
              </div>
              <div>
                <label>Activity<span class="req">*</span></label>
                <input type="text" id="activity" placeholder="e.g., Welcome & Registration" required />
              </div>
              <div style="grid-column:1/-1">
                <label>Key Outcome / Key Message<span class="req">*</span></label>
                <textarea id="outcome" placeholder="What success looks like / key talking points" required></textarea>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Ownership</div>
            <div class="grid-3">
              <div>
                <label>Presentation Owner</label>
                <input type="text" id="presentationOwner" placeholder="Name / team" />
              </div>
              <div>
                <label>Content Owner</label>
                <input type="text" id="contentOwner" placeholder="Name / team" />
              </div>
              <div style="grid-column:1/-1">
                <label>Notes</label>
                <textarea id="notes" placeholder="Internal notes or reminders"></textarea>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Tiers<span class="req"> *</span></div>
            <div class="tier-grid">
              <div><label>Tier 1</label><select class="tier" id="tier_1" required></select></div>
              <div><label>Tier 1.1</label><select class="tier" id="tier_1_1" required></select></div>
              <div><label>Tier 1.2</label><select class="tier" id="tier_1_2" required></select></div>
              <div><label>Tier 2</label><select class="tier" id="tier_2" required></select></div>
              <div><label>Tier 2.1</label><select class="tier" id="tier_2_1" required></select></div>
              <div><label>Tier 3</label><select class="tier" id="tier_3" required></select></div>
              <div><label>Tier 3.1</label><select class="tier" id="tier_3_1" required></select></div>
              <div><label>Tier 3.2</label><select class="tier" id="tier_3_2" required></select></div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">URL / Links</div>
            <div id="linksContainer" class="links-container"></div>
            <div><button type="button" class="btn btn-ghost btn-sm" id="addLinkBtn">+ Add Link</button></div>
            <div class="muted">Label is what appears in the list.</div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" id="resetBtn">Reset</button>
          <button type="button" class="btn btn-danger" id="editDeleteBtn" style="display:none">Delete</button>
          <button type="submit" class="btn btn-cta" id="submitBtn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Base scripts (ORDER MATTERS) -->
  <script src="assets/js/script.js"></script>
  <script src="assets/js/storage-xml-github.js"></script>
  <script src="assets/js/lego-settings.js"></script>

  <!-- Block any legacy PAT prompt -->
  <script>
    (function(){
      const _prompt = window.prompt;
      window.prompt = function(msg, def){
        if (/(personal access token|pat|records\.xml)/i.test(String(msg||''))) return '';
        return _prompt ? _prompt(msg, def) : null;
      };
    })();
  </script>

  <!-- Login + PAT (STRICT: verify token with GitHub before unlock) -->
  <script>
  (function(){
    const OWNER='markcolobong', REPO='cnslegoblocks', BRANCH='main', PATH='data/records.xml';
    const CONTENTS_URL = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}?ref=${encodeURIComponent(BRANCH)}`;

    const SESSION_KEY='lego_admin_logged_in';
    const TOKEN_KEY='lego_admin_pat';

    const logout=document.getElementById('logoutLink');
    const uEl=document.getElementById('gateUser');
    const pEl=document.getElementById('gatePass');
    const patRow=document.getElementById('patRow');
    const patEl=document.getElementById('gatePat');
    const enterBtn=document.getElementById('gateEnter');
    const errBox=document.getElementById('gateError');

    if (enterBtn) enterBtn.setAttribute('type','button');

    function sanitizeToken(t){
      return (t||'').trim().replace(/^[\"']+|[\"']+$/g,'').replace(/\s+/g,'').replace(/[\u200B-\u200D\uFEFF]/g,'');
    }
    function showErr(m){ errBox.textContent=m; errBox.style.display=''; }
    function clearErr(){ errBox.textContent=''; errBox.style.display='none'; }

    async function verifyToken(pat){
      const headers = { 'X-GitHub-Api-Version':'2022-11-28' };
      try{
        let r = await fetch(CONTENTS_URL + '&_ts=' + Date.now(), { cache:'no-store', headers:{...headers, Authorization:`token ${pat}`} });
        if (r.status !== 401) return r.status;
        r = await fetch(CONTENTS_URL + '&_ts=' + Date.now(), { cache:'no-store', headers:{...headers, Authorization:`Bearer ${pat}`} });
        if (r.status !== 401) return r.status;
        r = await fetch(CONTENTS_URL + '&_ts=' + Date.now(), { cache:'no-store', headers:{...headers, Authorization:'Basic '+btoa('x:'+pat)} });
        return r.status;
      }catch{
        return 0;
      }
    }

    async function forceFreshRender(){
      try{ await XmlGitHubStorage.load(); }catch{}
      try{ await window.LegoSettings?.refresh?.(); }catch{}
      setTimeout(async ()=>{ try{ await window.LegoSettings?.refresh?.(); }catch{} }, 200);
    }

    function unlockUI(pat){
      sessionStorage.setItem(TOKEN_KEY, pat);
      sessionStorage.setItem(SESSION_KEY, 'true');
      if (window.XmlGitHubStorage?.setToken) XmlGitHubStorage.setToken(pat);
      if (window.__authGuard?.unlock) __authGuard.unlock();
      else {
        document.documentElement.setAttribute('data-auth','unlocked');
        const app=document.getElementById('app'), gate=document.getElementById('gate');
        if (app) app.style.display=''; if (gate) gate.style.display='none';
      }
      if (logout) logout.style.display='';
      // First render after successful login always cache-busted
      forceFreshRender();
    }

    function lockUI(){
      sessionStorage.removeItem(SESSION_KEY);
      sessionStorage.removeItem(TOKEN_KEY);
      if (window.XmlGitHubStorage?.setToken) XmlGitHubStorage.setToken(null);
      if (window.__authGuard?.lock) __authGuard.lock();
      else {
        document.documentElement.setAttribute('data-auth','locked');
        const app=document.getElementById('app'), gate=document.getElementById('gate');
        if (app) app.style.display='none'; if (gate) gate.style.display='';
      }
      if (logout) logout.style.display='none';
    }

    let credsVerified=false, busy=false;

    (async function resume(){
      const logged = sessionStorage.getItem(SESSION_KEY)==='true';
      const tok = sessionStorage.getItem(TOKEN_KEY);
      if (logged && tok){
        const status = await verifyToken(tok);
        if (status===200 || status===404){
          unlockUI(tok);
        }else{
          lockUI();
        }
      }else{
        lockUI();
      }
    })();

    enterBtn?.addEventListener('click', async (e)=>{
      e.preventDefault();
      if (busy) return;
      clearErr();

      if (!credsVerified){
        const u=(uEl.value||'').trim();
        const p=(pEl.value||'').trim();
        if (u!=='admin' || p!=='+mark'){ showErr('Invalid credentials. Please try again.'); return; }
        credsVerified = true;
        patRow.style.display = '';
        enterBtn.textContent = 'Use Token';
        patEl.focus();
        return;
      }

      const pat = sanitizeToken(patEl.value);
      if (!pat){ showErr('Please enter a valid GitHub token.'); patEl.focus(); return; }

      const prev = enterBtn.textContent;
      busy = true; enterBtn.disabled = true; enterBtn.textContent = 'Validating…';

      const status = await verifyToken(pat);
      if (status===200 || status===404){
        unlockUI(pat);
      }else{
        showErr(status===401 ? 'Token rejected (401).'
              : status===403 ? 'Token lacks repo access (403).'
              : status===0   ? 'Network/CSP error contacting GitHub.'
                             : `Auth failed: ${status}`);
        lockUI();
      }
      busy = false; enterBtn.disabled = false; enterBtn.textContent = prev || 'Use Token';
    });

    document.getElementById('logoutLink')?.addEventListener('click', (e)=>{
      e.preventDefault();
      lockUI();
      credsVerified=false;
      patRow.style.display='none';
      enterBtn.textContent='Enter';
      uEl.value=''; pEl.value=''; patEl.value='';
    });

    // Expose a global re-render helper for other blocks below
    window.forceFreshLegoRender = forceFreshRender;
  })();
  </script>

  <!-- ADD: Append row only AFTER modal closes (post-save) + force fresh load from XML (commit-aware) -->
  <script>
  (function(){
    const $  = (id)=>document.getElementById(id);
    const q  = (sel, el=document)=>el.querySelector(sel);
    const qa = (sel, el=document)=>Array.from(el.querySelectorAll(sel));
    const S  = (v)=>String(v ?? '');

    const overlay  = $('modalOverlay');
    const form     = $('recordForm');
    const idInput  = $('recordId');
    const modalTit = $('modalTitle');
    const countPill= $('countPill');
    const addBtn   = $('openAddBtn');

    if (!overlay || !form) return;

    function parseCount(){ const m=(countPill?.textContent||'').match(/(\d+)/); return m?parseInt(m[1],10):NaN; }
    function setCount(n){ if (countPill && Number.isFinite(n)) countPill.textContent = `${n} records`; }

    // Clone first row as template so the instant row matches exact structure/styles
    function appendRowImmediate(rec){
      const tb  = q('#dataTable tbody');
      if (!tb) return;

      const tpl = tb.querySelector('tr');
      let tr;

      if (tpl){
        tr = tpl.cloneNode(true);
        tr.dataset.id = rec.id;

        const cells = tr.querySelectorAll('td');

        const setText = (idx, val) => {
          if (!cells[idx]) return;
          cells[idx].innerHTML = '';
          cells[idx].textContent = S(val);
        };
const setTier = (idx, val) => {
  if (!cells[idx]) return;
  const cell = cells[idx];
  // show ONLY a pill; clear any existing text/children
  cell.innerHTML = '';
  const pill = document.createElement('span');
  pill.className = 'pill';
  pill.setAttribute('data-value', S(val));
  pill.textContent = S(val);
  cell.appendChild(pill);
};

        // 0..3 text
        setText(0, rec.category);
        setText(1, rec.phase);
        setText(2, rec.activity);
        setText(3, rec.outcome);
        // 4..11 tiers
        setTier(4,  rec.tiers?.tier_1);
        setTier(5,  rec.tiers?.tier_1_1);
        setTier(6,  rec.tiers?.tier_1_2);
        setTier(7,  rec.tiers?.tier_2);
        setTier(8,  rec.tiers?.tier_2_1);
        setTier(9,  rec.tiers?.tier_3);
        setTier(10, rec.tiers?.tier_3_1);
        setTier(11, rec.tiers?.tier_3_2);

        // actions: ensure data-id targets new record
        const view = tr.querySelector('.view-link');
        const del  = tr.querySelector('.delete-link');
        if (view) view.setAttribute('data-id', rec.id);
        if (del)  del.setAttribute('data-id', rec.id);
      } else {
        // Fallback when table is initially empty (rare)
        tr = document.createElement('tr');
        tr.dataset.id = rec.id;
        const td = (t, cls)=>{ const el=document.createElement('td'); if (cls) el.className=cls; el.textContent=S(t); return el; };
        const mk = (v)=>{ const s=document.createElement('span'); s.className='pill'; s.setAttribute('data-value',S(v)); s.textContent=S(v); return s; };
        tr.appendChild(td(rec.category,'cat'));
        tr.appendChild(td(rec.phase,'phase'));
        tr.appendChild(td(rec.activity,'activity'));
        tr.appendChild(td(rec.outcome,'outcome'));
        const fr=document.createDocumentFragment();
        [['tier_1'],['tier_1_1'],['tier_1_2'],['tier_2'],['tier_2_1'],['tier_3'],['tier_3_1'],['tier_3_2']].forEach(([k])=>{
          const cell=document.createElement('td'); cell.className='tier-col'; cell.appendChild(mk(rec.tiers?.[k])); fr.appendChild(cell);
        });
        tr.appendChild(fr);
        const actions=document.createElement('td');
        actions.className='actions';
        actions.innerHTML = `
          <a href="#" class="tiny view-link" data-id="${rec.id}">View</a>
          <span class="sep">•</span>
          <a href="#" class="tiny danger delete-link" data-id="${rec.id}">Delete</a>
        `;
        tr.appendChild(actions);
      }
      
// normalize actions so they always carry the new id
const actionsCell = tr.querySelector('td.actions') || tr.lastElementChild;

if (actionsCell){
  actionsCell.querySelectorAll('a,button').forEach(el=>{
    el.setAttribute('data-id', rec.id);
    // add tolerant classnames / attrs so delegated handlers can find them
    const txt = (el.textContent || '').toLowerCase();
    if (txt.includes('view') || /view-?details|view-link|btn-view/.test(el.className)){
      el.classList.add('view-link');
      el.setAttribute('data-action','view');
    }
    if (txt.includes('delete') || /delete-link|btn-delete|danger/.test(el.className)){
      el.classList.add('delete-link');
      el.setAttribute('data-action','delete');
    }
  });
}

      tb.appendChild(tr);
    }

    // Always open in Add mode
    addBtn && addBtn.addEventListener('click', ()=>{
      if (modalTit) modalTit.textContent = 'Add Record';
      if (idInput) idInput.value = '';
      const del = document.getElementById('editDeleteBtn');
      if (del && del.style) del.style.display = 'none';
      form.dataset.mode = 'create';
      // Let CSS control centering; we only toggle aria
      document.getElementById('modalOverlay')?.setAttribute('aria-hidden','false');
    });

    // Capture Add submit to snapshot data & ensure the ID we want
    let pendingAdd = null;
    form.addEventListener('submit', (e)=>{
      const isCreate = (form.dataset.mode === 'create' && (!idInput || !idInput.value));
      if (!isCreate) return;

      // Derive next id from DOM to keep order nice; fallback unique id
      const rows = qa('#dataTable tbody tr[data-id]');
      const last = rows.length ? rows[rows.length-1].dataset.id || '' : '';
      let nextId;
      const m = last.match(/^(.*?)(\d+)$/);
      if (m){ const p=m[1], d=m[2]; nextId = p + String(parseInt(d,10)+1).padStart(d.length,'0'); }
      else nextId = 'r_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7);

      const rec = {
        id: nextId,
        category: document.getElementById('category')?.value || '',
        phase: document.getElementById('phase')?.value || '',
        activity: document.getElementById('activity')?.value?.trim() || '',
        outcome: document.getElementById('outcome')?.value?.trim() || '',
        presentationOwner: document.getElementById('presentationOwner')?.value?.trim() || '',
        contentOwner: document.getElementById('contentOwner')?.value?.trim() || '',
        notes: document.getElementById('notes')?.value?.trim() || '',
        links: Array.from(document.querySelectorAll('#linksContainer .link-row')).map(row => ({
          label: row.querySelector('.link-label')?.value || '',
          url:   row.querySelector('.link-url')?.value   || ''
        })),
        tiers: {
          tier_1:   document.getElementById('tier_1')?.value || '',
          tier_1_1: document.getElementById('tier_1_1')?.value || '',
          tier_1_2: document.getElementById('tier_1_2')?.value || '',
          tier_2:   document.getElementById('tier_2')?.value || '',
          tier_2_1: document.getElementById('tier_2_1')?.value || '',
          tier_3:   document.getElementById('tier_3')?.value || '',
          tier_3_1: document.getElementById('tier_3_1')?.value || '',
          tier_3_2: document.getElementById('tier_3_2')?.value || ''
        }
      };

      // Ensure your saver uses THIS id
      if (idInput) idInput.value = rec.id;
      pendingAdd = rec;
      // Do not preventDefault; your existing handler saves and closes modal
    }, true);

    // After the modal actually closes (save finished), append row then force fresh load from XML
    const mo = new MutationObserver(async (mlist)=>{
      for (const m of mlist){
        if (m.type==='attributes' && m.attributeName==='aria-hidden'){
          const nowHidden = overlay.getAttribute('aria-hidden') === 'true';
          if (nowHidden && pendingAdd){
            const rec = pendingAdd; pendingAdd = null;

            // Instant visible row + count
            appendRowImmediate(rec);
            const c=parseCount(); if (!isNaN(c)) setCount(c+1);

            // Fresh, commit-aware load → canonical re-render (uses session-stored commit SHA from save)
            if (window.forceFreshLegoRender) { try{ await window.forceFreshLegoRender(); }catch{} }
          }
        }
      }
    });
    mo.observe(overlay, { attributes:true, attributeFilter:['aria-hidden'] });
  })();
  </script>

  <!-- CSS tip:
       .modal-overlay[aria-hidden="true"]  { display:none; }
       .modal-overlay[aria-hidden="false"] { display:block; }  -->
  <!-- Stubborn fresh render shim: ensures the table always shows the latest file on load/refresh -->
<script>
(function(){
  async function stubbornPaint(reason){
    try {
      // 1) Clear any filter so the full list renders, same as when you manually clear Search
      const search = document.getElementById('search');
      if (search) {
        const prev = search.value;
        if (prev !== '') {
          search.value = '';
          search.dispatchEvent(new Event('input', { bubbles: true }));
        } else {
          // Even if empty, still fire input to trigger any code paths bound to search
          search.dispatchEvent(new Event('input', { bubbles: true }));
        }
      }

      // 2) Ask the app to re-render from XML (LegoSettings.refresh),
      //    then do a short follow-up to defeat any stale caches
      if (window.LegoSettings?.refresh) {
        try { await LegoSettings.refresh(); } catch {}
        setTimeout(() => { try { LegoSettings.refresh(); } catch {} }, 150);
      }
    } catch {}
  }

  // When a save just happened (we emit this from storage-xml-github.js)
  window.addEventListener('lego:recordsSaved', () => stubbornPaint('saved'));

  // When the page (re)appears or loads
  window.addEventListener('pageshow', () => stubbornPaint('pageshow'));
  document.addEventListener('DOMContentLoaded', () => stubbornPaint('domready'));
  window.addEventListener('focus', () => stubbornPaint('focus'));

  // Also run right after a successful login unlock
  const guard = window.__authGuard;
  if (guard && typeof guard.unlock === 'function') {
    const origUnlock = guard.unlock.bind(guard);
    guard.unlock = function(){
      const r = origUnlock();
      stubbornPaint('unlock');
      return r;
    };
  }
})();
</script>
<script>
(function(){
  const SS_LAST_SHA = 'lego_last_commit_sha';

  const $  = (id)=>document.getElementById(id);
  const q  = (sel, el=document)=>el.querySelector(sel);
  const qa = (sel, el=document)=>Array.from(el.querySelectorAll(sel));
  const S  = (v)=>String(v ?? '');

  // Build a single TR that matches your table’s look & feel.

 <script>
(function(){
  const $  = (id)=>document.getElementById(id);
  const q  = (sel, el=document)=>el.querySelector(sel);
  const qa = (sel, el=document)=>Array.from(el.querySelectorAll(sel));
  const S  = (v)=>String(v ?? '');

  // Build a single TR that matches your table’s look & feel.
  // ✅ Fixed: no stray `};` — all braces balanced.
  function buildRow(rec, templateRow){
    let tr;
    if (templateRow){
      tr = templateRow.cloneNode(true);
      tr.dataset.id = rec.id;

      const cells = tr.querySelectorAll('td');

      const setText = (idx, val) => {
        if (!cells[idx]) return;
        cells[idx].innerHTML = '';
        cells[idx].textContent = S(val);
      };
      const setTier = (idx, val) => {
        if (!cells[idx]) return;
        const cell = cells[idx];
        cell.innerHTML = '';
        const pill = document.createElement('span');
        pill.className = 'pill';
        pill.setAttribute('data-value', S(val));
        pill.textContent = S(val);
        cell.appendChild(pill);
      };

      // 0..3 text
      setText(0, rec.category);
      setText(1, rec.phase);
      setText(2, rec.activity);
      setText(3, rec.outcome);
      // 4..11 tiers
      setTier(4,  rec.tiers?.tier_1);
      setTier(5,  rec.tiers?.tier_1_1);
      setTier(6,  rec.tiers?.tier_1_2);
      setTier(7,  rec.tiers?.tier_2);
      setTier(8,  rec.tiers?.tier_2_1);
      setTier(9,  rec.tiers?.tier_3);
      setTier(10, rec.tiers?.tier_3_1);
      setTier(11, rec.tiers?.tier_3_2);

      // normalize actions so View/Delete target the new id
      const actionsCell = tr.querySelector('td.actions') || tr.lastElementChild;
      if (actionsCell){
        actionsCell.querySelectorAll('a,button').forEach(el=>{
          el.setAttribute('data-id', rec.id);
          const txt = (el.textContent || '').toLowerCase();
          if (txt.includes('view') || /view-?details|view-link|btn-view/.test(el.className)){
            el.classList.add('view-link');
            el.setAttribute('data-action','view');
          }
          if (txt.includes('delete') || /delete-link|btn-delete|danger/.test(el.className)){
            el.classList.add('delete-link');
            el.setAttribute('data-action','delete');
          }
        });
      }
    } else {
      // Fallback when the table was empty
      tr = document.createElement('tr');
      tr.dataset.id = rec.id;

      const td = (t, cls)=>{ const el=document.createElement('td'); if (cls) el.className=cls; el.textContent=S(t); return el; };
      const mk = (v)=>{ const s=document.createElement('span'); s.className='pill'; s.setAttribute('data-value',S(v)); s.textContent=S(v); return s; };

      tr.appendChild(td(rec.category,'cat'));
      tr.appendChild(td(rec.phase,'phase'));
      tr.appendChild(td(rec.activity,'activity'));
      tr.appendChild(td(rec.outcome,'outcome'));

      ['tier_1','tier_1_1','tier_1_2','tier_2','tier_2_1','tier_3','tier_3_1','tier_3_2'].forEach(k=>{
        const cell=document.createElement('td'); cell.className='tier-col'; cell.appendChild(mk(rec.tiers?.[k])); tr.appendChild(cell);
      });

      const actions=document.createElement('td');
      actions.className='actions';
      actions.innerHTML = `
        <a href="#" class="tiny view-link" data-id="${rec.id}">View</a>
        <span class="sep">•</span>
        <a href="#" class="tiny danger delete-link" data-id="${rec.id}">Delete</a>
      `;
      tr.appendChild(actions);
    }

    return tr;
  }

  // expose if you need it elsewhere in this block scope
  window.__lego_buildRow = buildRow;
})();
</script>


  

  function setCount(n){
    const pill = $('countPill');
    if (pill) pill.textContent = `${n} records`;
  }

  // Hard repaint from XML (commit-aware)
  async function loadFreshRecords(){
    const stickySha = (sessionStorage.getItem(SS_LAST_SHA) || '').trim();
    try{
      if (stickySha && window.XmlGitHubStorage?.loadAtRef){
        const recs = await XmlGitHubStorage.loadAtRef(stickySha);
        if (Array.isArray(recs)) return recs;
      }
    }catch{}
    // Fallback to normal load (already cache-busted in storage file)
    try { return await XmlGitHubStorage.load(); } catch { return []; }
  }

  async function hardRepaint(reason){
    const tb = q('#dataTable tbody');
    if (!tb) return;
    // Clear any active search filter (this mimics what you do manually)
    const search = $('search');
    if (search){
      const prev = search.value;
      if (prev !== '') {
        search.value = '';
        search.dispatchEvent(new Event('input', { bubbles: true }));
      }
    }

    // Fetch the freshest possible XML and rebuild
    const records = await loadFreshRecords();

    // Keep a template row (first existing row) for consistent formatting
    const templateRow = tb.querySelector('tr');

    const frag = document.createDocumentFragment();
    (records || []).forEach(rec => frag.appendChild(buildRow(rec, templateRow)));
    tb.innerHTML = '';
    tb.appendChild(frag);
    setCount(records.length);

    // Let existing code re-bind anything it delegates after DOM update
    try { window.dispatchEvent(new CustomEvent('lego:tableRepainted', { detail: { reason, count: records.length } })); } catch {}
  }

  // ---- Wire-up: repaint on all the right lifecycle moments ----
  // After a successful save (our storage emits this)
  window.addEventListener('lego:recordsSaved', ()=> hardRepaint('saved'));

  // On first unlock (login success)
  (function hookUnlock(){
    if (!window.__authGuard || typeof __authGuard.unlock !== 'function') return;
    const orig = __authGuard.unlock.bind(__authGuard);
    __authGuard.unlock = function(){
      const r = orig();
      hardRepaint('unlock');
      return r;
    };
  })();

  // On initial load/refresh and when tab refocuses
  document.addEventListener('DOMContentLoaded', ()=> hardRepaint('domready'));
  window.addEventListener('pageshow', ()=> hardRepaint('pageshow'));
  window.addEventListener('focus', ()=> hardRepaint('focus'));
})();
</script>
  
<script>
(function(){
  // Handle View Details clicks even on freshly appended rows
  document.addEventListener('click', function(e){
    const el = e.target.closest('[data-action="view"], .view-link, .view-details, .btn-view');
    if (!el) return;
    e.preventDefault();

    const id = el.getAttribute('data-id') || el.closest('tr')?.dataset.id;
    if (!id) return;

    // Prefer your existing API if it exists
    if (window.LegoSettings?.openDetailsById) { try{ LegoSettings.openDetailsById(id); }catch{} return; }
    if (window.LegoSettings?.openDetails)     { try{ LegoSettings.openDetails(id);     }catch{} return; }

    // Fallback: emit an event for lego-settings.js to catch
    try { window.dispatchEvent(new CustomEvent('lego:openDetails', { detail: { id } })); } catch {}
  }, true);
})();
</script>

<script>
(function(){
  async function forceFreshUI(reason){
    try {
      // Load from the last commit if we have it (commit-aware), else normal
      const recs = (window.XmlGitHubStorage?.loadFreshPreferringSha)
        ? await XmlGitHubStorage.loadFreshPreferringSha()
        : (await (window.XmlGitHubStorage?.load?.() || []));

      // Clear any search filter so full list is visible (mirrors your manual workaround)
      const search = document.getElementById('search');
      if (search) {
        search.value = '';
        search.dispatchEvent(new Event('input', { bubbles: true }));
      }

      // Ask your existing code to repaint with fresh data
      if (window.LegoSettings?.refresh) {
        try { await LegoSettings.refresh(); } catch {}
      }

      // Safety: kick a follow-up repaint shortly after (defeats any stale overpaint)
      setTimeout(() => { try { window.LegoSettings?.refresh?.(); } catch {} }, 150);
    } catch {}
  }

  // After a successful save (file definitely updated)
  window.addEventListener('lego:recordsSaved', () => forceFreshUI('saved'));

  // On first unlock/login
  if (window.__authGuard && typeof __authGuard.unlock === 'function') {
    const _u = __authGuard.unlock.bind(__authGuard);
    __authGuard.unlock = function(){
      const r = _u();
      forceFreshUI('unlock');
      return r;
    };
  }

  // On page load / refresh / tab focus
  document.addEventListener('DOMContentLoaded', () => forceFreshUI('domready'));
  window.addEventListener('pageshow', () => forceFreshUI('pageshow'));
  window.addEventListener('focus', () => forceFreshUI('focus'));
})();
</script>

  
</body>
</html>








