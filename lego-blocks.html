<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lego Blocks Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="assets/css/lego-settings.css" />

  <!-- HARD GATE: prevents any script from showing #app before auth -->
  <script>
    (function(){
      const SESSION_KEY='lego_admin_logged_in';
      const TOKEN_KEY='lego_admin_pat';
      document.documentElement.setAttribute('data-auth','locked');

      document.addEventListener('DOMContentLoaded', () => {
        const app  = document.getElementById('app');
        const gate = document.getElementById('gate');

        function locked(){
          return !(sessionStorage.getItem(SESSION_KEY)==='true' && sessionStorage.getItem(TOKEN_KEY));
        }
        function enforce(){
          if (!app || !gate) return;
          if (locked()){
            app.style.display = 'none';
            gate.style.display = '';
          }
        }
        enforce();

        const mo = new MutationObserver(enforce);
        mo.observe(document.body, { attributes:true, childList:true, subtree:true });

        window.__authGuard = {
          unlock(){
            sessionStorage.setItem(SESSION_KEY,'true');
            document.documentElement.setAttribute('data-auth','unlocked');
            mo.disconnect();
            if (app) app.style.display = '';
            if (gate) gate.style.display = 'none';
          },
          lock(){
            sessionStorage.removeItem(SESSION_KEY);
            sessionStorage.removeItem(TOKEN_KEY);
            document.documentElement.setAttribute('data-auth','locked');
            enforce();
          }
        };
      });
    })();
  </script>
</head>
<body>
  <div class="bg-fixed bg-lego"></div>

  <header class="nav-wrap container">
    <div class="nav panel">
      <div class="brand">
        <img class="brand-logo" src="./assets/images/ey.png" alt="EY Logo" />
        <span>GDS Consulting Visit Lego Blocks</span>
      </div>
      <ul class="menu">
        <li><a href="index.html#home">Home</a></li>
        <li>
          <a href="#settings" id="menuSettings">Settings ▾</a>
          <ul class="submenu">
            <li>
              <a href="lego-blocks.html" id="menuLegoBlocks" role="menuitem" style="display:block;padding:10px 12px;border-radius:8px">
                Lego Blocks
              </a>
            </li>
          </ul>
        </li>
        <li><a href="index.html#contact">Contact Us</a></li>
        <li><a href="#" id="logoutLink" style="display:none">Logout</a></li>
      </ul>
    </div>
  </header>

  <!-- APP (hidden until login + PAT) -->
  <div id="app" style="display:none">
    <main class="wrap" id="settings">
      <section class="panel hero hero-tight">
        <h1>Lego Blocks Settings</h1>
        <p>Manage records, tiers, links, and attachments for your visit building blocks.</p>
        <div class="toolbar row-actions">
          <input id="search" type="text" placeholder="Search records…" />
        </div>
      </section>

      <section class="panel adv">
        <div class="records-head">
          <div class="left">
            <div class="card-title">Records</div>
            <button class="btn btn-cta" id="openAddBtn">+ Add record</button>
          </div>
          <div class="right tiny-links">
            <a href="#" id="exportLink">Export</a>
            <a href="#" id="importLink">Import</a>
            <a href="#" id="clearAllLink">Clear All</a>
            <span class="count" id="countPill">0 records</span>
            <input type="file" id="csvFile" accept=".csv,text/csv" style="display:none" />
          </div>
        </div>

        <div class="card-body glass-inner">
          <div class="table-wrap">
            <table id="dataTable" aria-describedby="countPill">
              <thead>
                <tr>
                  <th class="cat">Category</th>
                  <th class="phase">Phase</th>
                  <th class="activity">Activity</th>
                  <th class="outcome">Key Outcome / Key Message</th>
                  <th class="tier-col">T1</th>
                  <th class="tier-col">T1.1</th>
                  <th class="tier-col">T1.2</th>
                  <th class="tier-col">T2</th>
                  <th class="tier-col">T2.1</th>
                  <th class="tier-col">T3</th>
                  <th class="tier-col">T3.1</th>
                  <th class="tier-col">T3.2</th>
                  <th class="actions">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="muted" style="margin-top:12px">
            Tip: You can download/upload multiple records at once. To upload, download this
            <a href="#" id="templateCsvLink">Import template.csv</a>
            and import using the links above.
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- LOGIN GATE -->
  <div id="gate" class="gate" aria-hidden="false">
    <div class="gate-card panel">
      <div class="gate-header">
        <h2>Admin Sign-in</h2>
        <p class="muted">Enter your admin credentials, then provide a GitHub token for saving.</p>
      </div>
      <div class="gate-form">
        <div class="field">
          <label for="gateUser">Username</label>
          <input id="gateUser" type="text" placeholder="Username" autocomplete="username" autofocus />
        </div>
        <div class="field">
          <label for="gatePass">Password</label>
          <input id="gatePass" type="password" placeholder="Password" autocomplete="current-password" />
        </div>

        <!-- Revealed ONLY after username/password are correct -->
        <div class="field" id="patRow" style="display:none">
          <label for="gatePat">GitHub PAT (Contents: read/write)</label>
          <input id="gatePat" type="password" placeholder="ghp_…" />
          <div class="muted" style="margin-top:6px">Token is kept for this tab until you close it.</div>
        </div>

        <div class="actions">
          <button class="btn btn-cta" id="gateEnter">Enter</button>
        </div>
        <div class="muted" id="gateError" style="display:none;color:#d33;margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- DETAILS modal -->
  <div class="modal-overlay" id="detailsOverlay" aria-hidden="true">
    <div class="modal panel" role="dialog" aria-modal="true" aria-labelledby="detailsTitle">
      <div class="modal-header">
        <div class="modal-title" id="detailsTitle">Record Details</div>
        <button class="btn btn-ghost" id="closeDetailsBtn">Close</button>
      </div>
      <div class="modal-body"><div id="detailsBody"></div></div>
      <div class="modal-footer">
        <button class="btn btn-ghost" id="detailsEditBtn">Edit</button>
        <button class="btn btn-danger" id="detailsDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit modal -->
  <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
    <div class="modal panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Add Record</div>
        <button class="btn btn-ghost" id="closeModalBtn">Close</button>
      </div>
      <form id="recordForm">
        <input type="hidden" id="recordId" />
        <div class="modal-body">
          <div class="section">
            <div class="section-title">Core Details</div>
            <div class="grid-3">
              <div>
                <label>Category<span class="req">*</span></label>
                <select id="category" required>
                  <option value="">— Select —</option>
                  <option>Preparation</option><option>Presentation</option><option>Group Meet</option>
                  <option>Experience</option><option>Collaboration</option><option>Post Event</option>
                </select>
              </div>
              <div>
                <label>Phase<span class="req">*</span></label>
                <select id="phase" required>
                  <option value="">— Select —</option>
                  <option>PRE</option><option>DURING</option><option>POST</option>
                </select>
              </div>
              <div>
                <label>Activity<span class="req">*</span></label>
                <input type="text" id="activity" placeholder="e.g., Welcome & Registration" required />
              </div>
              <div style="grid-column:1/-1">
                <label>Key Outcome / Key Message<span class="req">*</span></label>
                <textarea id="outcome" placeholder="What success looks like / key talking points" required></textarea>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Ownership</div>
            <div class="grid-3">
              <div>
                <label>Presentation Owner</label>
                <input type="text" id="presentationOwner" placeholder="Name / team" />
              </div>
              <div>
                <label>Content Owner</label>
                <input type="text" id="contentOwner" placeholder="Name / team" />
              </div>
              <div style="grid-column:1/-1">
                <label>Notes</label>
                <textarea id="notes" placeholder="Internal notes or reminders"></textarea>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Tiers<span class="req"> *</span></div>
            <div class="tier-grid">
              <div><label>Tier 1</label><select class="tier" id="tier_1" required></select></div>
              <div><label>Tier 1.1</label><select class="tier" id="tier_1_1" required></select></div>
              <div><label>Tier 1.2</label><select class="tier" id="tier_1_2" required></select></div>
              <div><label>Tier 2</label><select class="tier" id="tier_2" required></select></div>
              <div><label>Tier 2.1</label><select class="tier" id="tier_2_1" required></select></div>
              <div><label>Tier 3</label><select class="tier" id="tier_3" required></select></div>
              <div><label>Tier 3.1</label><select class="tier" id="tier_3_1" required></select></div>
              <div><label>Tier 3.2</label><select class="tier" id="tier_3_2" required></select></div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">URL / Links</div>
            <div id="linksContainer" class="links-container"></div>
            <div><button type="button" class="btn btn-ghost btn-sm" id="addLinkBtn">+ Add Link</button></div>
            <div class="muted">Label is what appears in the list.</div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" id="resetBtn">Reset</button>
          <button type="button" class="btn btn-danger" id="editDeleteBtn" style="display:none">Delete</button>
          <button type="submit" class="btn btn-cta" id="submitBtn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Base scripts -->
  <script src="assets/js/script.js"></script>
  <script src="assets/js/storage-xml-github.js"></script>

  <!-- Block any legacy PAT prompt -->
  <script>
    (function(){
      const _prompt = window.prompt;
      window.prompt = function(msg, def){
        if (/(personal access token|pat|records\.xml)/i.test(String(msg||''))) return '';
        return _prompt ? _prompt(msg, def) : null;
      };
    })();
  </script>

  <script src="assets/js/lego-settings.js"></script>

 <!-- Login + PAT on same card + session -->
<script>
(function(){
  // --- constants / keys ---
  const OWNER='markcolobong', REPO='cnslegoblocks', BRANCH='main', PATH='data/records.xml';
  const SESSION_KEY='lego_admin_logged_in';
  const TOKEN_KEY='lego_admin_pat';

  // --- gate elements ---
  const logout = document.getElementById('logoutLink');
  const uEl    = document.getElementById('gateUser');
  const pEl    = document.getElementById('gatePass');
  const patRow = document.getElementById('patRow');
  const patEl  = document.getElementById('gatePat');
  const enterBtn = document.getElementById('gateEnter');
  const errBox = document.getElementById('gateError');

  // Ensure button never submits the form
  if (enterBtn) enterBtn.setAttribute('type','button');

  // --- add record button state (#6) ---
  const addBtn = document.getElementById('openAddBtn');
  function syncAddBtnEnabled(){
    if (!addBtn) return;
    const unlocked = (document.documentElement.getAttribute('data-auth') === 'unlocked');
    const hasToken = (window.XmlGitHubStorage && XmlGitHubStorage.hasToken && XmlGitHubStorage.hasToken());
    addBtn.disabled = !(unlocked && hasToken);
  }
  setInterval(syncAddBtnEnabled, 500);

  // --- small utils ---
  function sanitizeToken(t){
    return (t||'').trim()
      .replace(/^[\"']+|[\"']+$/g,'')    // strip surrounding quotes
      .replace(/\s+/g,'')                // remove whitespace
      .replace(/[\u200B-\u200D\uFEFF]/g,''); // zero-width chars
  }
  function showErr(m){ errBox.textContent = m; errBox.style.display = ''; }
  function clearErr(){ errBox.textContent = ''; errBox.style.display = 'none'; }

  let credsVerified = false;
  let busy = false;

  // --- resume: if session has a token, unlock immediately ---
  (async function resume(){
    const logged = sessionStorage.getItem(SESSION_KEY) === 'true';
    const tok    = sessionStorage.getItem(TOKEN_KEY);
    if (logged && tok){
      if (window.XmlGitHubStorage && typeof XmlGitHubStorage.setToken === 'function'){
        XmlGitHubStorage.setToken(tok);
      }
      // Aggressive unlock so UI flips even if guard isn't yet ready
      sessionStorage.setItem(SESSION_KEY,'true');
      document.documentElement.setAttribute('data-auth','unlocked');
      const app = document.getElementById('app');
      const gate = document.getElementById('gate');
      if (app)  app.style.display = '';
      if (gate) gate.style.display = 'none';
      if (logout) logout.style.display = '';

      // Try refreshing table, but don't break flow if it fails
      try{
        if (window.LegoSettings && typeof LegoSettings.refresh === 'function'){
          await LegoSettings.refresh();
        }
      }catch{}
    }else{
      // keep gate visible until credentials + token are provided
      if (window.__authGuard && typeof __authGuard.lock === 'function'){
        window.__authGuard.lock();
      }
    }
  })();

  // --- main click handler: username/pass first, then accept token & unlock ---
  enterBtn?.addEventListener('click', async (e)=>{
    e.preventDefault();            // never submit the gate form
    if (busy) return;
    clearErr();

    // Phase 1: username/password
    if (!credsVerified){
      const u = (uEl.value||'').trim();
      const p = (pEl.value||'').trim();
      if (u !== 'admin' || p !== '+mark'){
        showErr('Invalid credentials. Please try again.');
        return;
      }
      credsVerified = true;
      patRow.style.display = '';
      enterBtn.textContent = 'Use Token';
      patEl.focus();
      return;
    }

    // Phase 2: accept token and unlock immediately (no remote probe)
    const pat = sanitizeToken(patEl.value);
    if (!pat){
      showErr('Please enter a valid GitHub token.');
      patEl.focus();
      return;
    }

    // loading UI
    const prevLabel = enterBtn.textContent;
    busy = true;
    enterBtn.disabled = true;
    enterBtn.textContent = 'Unlocking…';

    try{
      // persist token + session
      sessionStorage.setItem(TOKEN_KEY, pat);
      sessionStorage.setItem(SESSION_KEY, 'true');

      // wire token to storage
      if (window.XmlGitHubStorage && typeof XmlGitHubStorage.setToken === 'function'){
        XmlGitHubStorage.setToken(pat);
      }

      // flip UI immediately
      document.documentElement.setAttribute('data-auth','unlocked');
      const app = document.getElementById('app');
      const gate = document.getElementById('gate');
      if (app)  app.style.display = '';
      if (gate) gate.style.display = 'none';
      if (logout) logout.style.display = '';

      // refresh table (safe)
      try{
        if (window.LegoSettings && typeof LegoSettings.refresh === 'function'){
          await LegoSettings.refresh();
        }
      }catch{}
    }catch(err){
      console.error(err);
      showErr(err?.message || 'Unexpected error while unlocking.');
    }finally{
      busy = false;
      enterBtn.disabled = false;
      enterBtn.textContent = prevLabel || 'Use Token';
      syncAddBtnEnabled();
    }
  });

  // --- logout handler ---
  logout?.addEventListener('click', (e)=>{
    e.preventDefault();
    sessionStorage.removeItem(SESSION_KEY);
    sessionStorage.removeItem(TOKEN_KEY);
    if (window.XmlGitHubStorage && typeof XmlGitHubStorage.setToken === 'function'){
      XmlGitHubStorage.setToken(null);
    }
    if (window.__authGuard && typeof __authGuard.lock === 'function'){
      window.__authGuard.lock();
    }
    const app = document.getElementById('app');
    const gate = document.getElementById('gate');
    if (app)  app.style.display = 'none';
    if (gate) gate.style.display = '';
    if (logout) logout.style.display = 'none';
    credsVerified = false;
    patRow.style.display = 'none';
    enterBtn.textContent = 'Enter';
    uEl.value = ''; pEl.value = ''; patEl.value = '';
    syncAddBtnEnabled();
  });
})();
</script>



  <!-- Add Record glue: open modal, save/delete via XmlGitHubStorage -->
  <script>
  (function(){
    const $ = (id) => document.getElementById(id);
    const appReady = () => document.documentElement.getAttribute('data-auth') === 'unlocked';

    const addBtn = $('openAddBtn');
    const overlay = $('modalOverlay');
    const closeBtn = $('closeModalBtn');
    const form = $('recordForm');
    const idInput = $('recordId');

    function openModalForCreate(){
      if (!overlay) return;
      if (form) form.reset();
      if (idInput) idInput.value = '';
      overlay.setAttribute('aria-hidden','false');
      overlay.classList.add('open'); // (#4) show via class too
    }
    function closeModal(){
      if (!overlay) return;
      overlay.setAttribute('aria-hidden','true');
      overlay.classList.remove('open'); // (#4) hide via class too
    }

    addBtn?.addEventListener('click', (e)=>{
      e.preventDefault();
      if (!appReady()) return;
      openModalForCreate();
    });
    closeBtn?.addEventListener('click', (e)=>{ e.preventDefault(); closeModal(); });
    overlay?.addEventListener('click', (e)=>{ if (e.target === overlay) closeModal(); });

    if (form && !form.dataset.boundSave){
      form.dataset.boundSave = 'true';

      const val = (id) => ($(id) ? $(id).value : '');
      const text = (id) => ($(id) ? $(id).value.trim() : '');

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (!window.XmlGitHubStorage || typeof XmlGitHubStorage.upsertOne !== 'function'){
          console.error('XmlGitHubStorage not available.'); return;
        }
        if (!XmlGitHubStorage.hasToken || !XmlGitHubStorage.hasToken()){
          alert('Write disabled: please login with a valid GitHub token first.');
          return;
        }
        const record = {
          id: val('recordId') || ('r_' + Math.random().toString(36).slice(2) + Date.now().toString(36)),
          category: val('category'),
          phase: val('phase'),
          activity: text('activity'),
          outcome: text('outcome'),
          presentationOwner: text('presentationOwner'),
          contentOwner: text('contentOwner'),
          notes: text('notes'),
          links: Array.from(document.querySelectorAll('#linksContainer .link-row')).map(row => ({
            label: row.querySelector('.link-label')?.value || '',
            url:   row.querySelector('.link-url')?.value   || ''
          })),
          tiers: {
            tier_1:   val('tier_1'),
            tier_1_1: val('tier_1_1'),
            tier_1_2: val('tier_1_2'),
            tier_2:   val('tier_2'),
            tier_2_1: val('tier_2_1'),
            tier_3:   val('tier_3'),
            tier_3_1: val('tier_3_1'),
            tier_3_2: val('tier_3_2')
          }
        };

        if (!record.category || !record.phase || !record.activity || !record.outcome){
          alert('Please complete Category, Phase, Activity, and Outcome.');
          return;
        }

        const submitBtn = $('submitBtn');
        const prevLabel = submitBtn ? submitBtn.textContent : '';
        if (submitBtn){ submitBtn.disabled = true; submitBtn.textContent = 'Saving…'; }

        try{
          await XmlGitHubStorage.upsertOne(record);
          if (idInput) idInput.value = record.id;
          // Guarded refresh (#5)
          try {
            await (window.LegoSettings && typeof LegoSettings.refresh === 'function' ? LegoSettings.refresh() : Promise.resolve());
          } catch {}
          closeModal();
        }catch(err){
          console.error(err);
          alert('Save failed: ' + (err?.message || err));
        }finally{
          if (submitBtn){ submitBtn.disabled = false; submitBtn.textContent = prevLabel || 'Save'; }
        }
      });

      const delBtn = $('editDeleteBtn');
      delBtn?.addEventListener('click', async ()=>{
        if (!XmlGitHubStorage.hasToken || !XmlGitHubStorage.hasToken()){
          alert('Write disabled: please login with a valid GitHub token first.');
          return;
        }
        const id = (idInput ? idInput.value : '');
        if (!id){ alert('No record selected.'); return; }
        if (!confirm('Delete this record?')) return;

        try{
          await XmlGitHubStorage.deleteOne(id);
          // Guarded refresh (#5)
          try {
            await (window.LegoSettings && typeof LegoSettings.refresh === 'function' ? LegoSettings.refresh() : Promise.resolve());
          } catch {}
          form.reset();
          if (idInput) idInput.value = '';
          closeModal();
        }catch(err){
          console.error(err);
          alert('Delete failed: ' + (err?.message || err));
        }
      });
    }
  })();
  </script>

  <!-- NOTE for CSS (#4):
       Ensure your CSS includes:
       .modal-overlay[aria-hidden="true"] { display:none; }
       .modal-overlay.open { display:block; }  (or flex)
  -->
</body>
</html>



