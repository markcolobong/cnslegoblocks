<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LegoBlocks-Home</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Site CSS -->
  <link rel="stylesheet" href="assets/css/style.css" />

  <!-- Resolver-specific layout fixes and small tweaks -->
  <style>
    /* spacing for the resolver panel so nothing hugs the edge */
    #resolverPanel { padding: 30px 24px; margin-bottom: 24px; }

    /* sentence spacing */
    .sentence { margin-bottom: 16px; }

    /* chip styling */
    .word{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:12px; cursor:pointer;
      background:var(--panel); border:1px solid var(--glass-stroke);
      font-weight:600; line-height:1;
    }
    .word.empty{ color:var(--muted); font-weight:500 }
    .word.selected{ border-color:rgba(37,99,235,.25); background:rgba(37,99,235,.06) }
    .inline{ margin-left:12px }

    /* buttons – modern look */
    .cta{ display:flex; gap:10px; margin: 14px 0 20px; }
    .btn{
      border-radius:12px; padding:8px 14px; font-weight:700;
      border:1px solid var(--glass-stroke); background:#fff; color:#0b1324; cursor:pointer;
    }
    .btn:hover{ background:#f8f9fa }
    .btn.primary{ background:var(--brand); color:#fff; border:none }
    .btn.primary:hover{ filter:brightness(.95) }

    /* results card */
    #outCard {
      margin-top: 20px;
      border: 1px solid var(--glass-stroke);
      border-radius: 14px;
      padding: 16px;
      background: #fff;
    }
    #outCard .title { font-weight:700; margin-bottom:6px }
    #outCard .pill { font-size:12px; padding:2px 8px; border-radius:12px; background:#f1f5f9 }
    #outCard .card-b{ margin-top: 10px; }

    /* table-like header + rows (same grid) */
    .results-grid-header,
    #resultList .row{
      display:grid;
      grid-template-columns: 120px 80px 240px 1fr auto; /* Category | Phase | Activity | Outcome | Actions */
      gap:8px; align-items:center;
    }
    .results-grid-header{
      font-size:12.5px; color:#475569; font-weight:700;
      padding:8px 0; border-bottom:1px solid #e5e7eb;
    }
    #resultList{ margin-top:6px; }
    #resultList .row{ padding:10px 0; border-bottom:1px solid #e5e7eb }
    #resultList .row:last-child{ border-bottom:none }

    #resultList .cap,
    #resultList .phase,
    #resultList .act,
    #resultList .outcome { font-size:14px; }

    /* session-only delete icon (red 'X') */
    #resultList .kill{
      background:transparent; color:#ef4444; border:none;
      font-weight:800; font-size:16px; line-height:1; cursor:pointer;
      padding:2px 8px; border-radius:8px;
    }
    #resultList .kill:hover{ background:#fee2e2 }

    /* download bottom-right with spacing */
    #downloadWrap{
      display:flex; justify-content:flex-end;
      margin-top:16px; padding-top:10px; border-top:1px solid #e5e7eb;
    }

    /* popover visuals (kept minimal + inline) */
    .popover{
      position:absolute; left:0; top:100%; margin-top:8px; min-width:320px;
      background:rgba(255,255,255,.98); border:1px solid rgba(0,0,0,.08);
      border-radius:14px; box-shadow:0 30px 100px rgba(2,6,23,.25); padding:10px;
      text-align:left; z-index:2000; backdrop-filter:blur(8px)
    }
    .popover .pop-title{ font-weight:800; margin:2px 0 8px 2px; font-size:13px; color:#0b1324 }
    .popover .opts{ max-height:260px; overflow:auto; padding-right:4px }
    .popover .opt{ display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:10px; cursor:pointer }
    .popover .opt:hover{ background:rgba(15,23,42,.05) }
    .popover .actions{ display:flex; gap:8px; justify-content:flex-end; padding-top:10px; border-top:1px solid #d9e0ea; margin-top:8px }
    .popover .apply{ background:var(--brand); color:#fff; border:none; border-radius:10px; padding:6px 12px }

    /* Contact widget – compact */
    #contact.panel.hero{ padding: 24px 20px; }
    #contact h2{ margin-bottom: 6px; text-align:center; }
    #contact p{ margin: 0; }
  </style>
</head>
<body>
  <div class="bg-fixed"></div>

  <!-- NAVBAR with dropdown -->
  <header class="nav-wrap container">
    <div class="nav panel">
      <div class="brand">
        <img class="brand-logo" src="./assets/images/ey.png" alt="EY Logo" />
        <span>GDS Consulting Visit Lego Blocks</span>
      </div>
      <ul class="menu">
        <li><a href="#home">Home</a></li>
        <li>
          <a href="#settings">Settings ▾</a>
          <ul class="submenu">
            <li><a href="lego-blocks.html">Lego Blocks</a></li>
          </ul>
        </li>
        <li><a href="#contact">Contact Us</a></li>
      </ul>
    </div>
  </header>

  <!-- Main sections -->
  <main class="wrap" id="home">
    <section class="panel hero">
      <h1>Welcome to GDS Consulting<br>Lego Blocks</h1>
      <p>Your one-stop shop for all visit-related tasks to ensure an exceptional Consulting Philippines experience</p>
      <div class="thumbs">
        <div class="thumb"><img src="https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?q=80&w=1200&auto=format&fit=crop" alt=""></div>
        <div class="thumb"><img src="https://images.unsplash.com/photo-1551434678-e076c223a692?q=80&w=1200&auto=format&fit=crop" alt=""></div>
        <div class="thumb"><img src="https://images.unsplash.com/photo-1552664730-d307ca884978?q=80&w=1200&auto=format&fit=crop" alt=""></div>
      </div>
    </section>

    <!-- Visitor Tier Resolver -->
    <section class="panel" id="resolverPanel" style="position:relative">
      <h2>Visitor Tier Resolver</h2>
      <section class="content">
        <div class="sentence" id="q">
          To plan this visit, I am hosting
          <span id="levelField" class="word empty" role="button" aria-haspopup="listbox" aria-expanded="false" title="Select visitor level(s)">any level</span>
          attending as
          <span id="typeField" class="word empty" role="button" aria-haspopup="listbox" aria-expanded="false" title="Select visitor type(s)">any type</span>.
          <span id="customerChunk" class="inline" style="display:none">
            Customer type:
            <span id="custField" class="word" role="button" aria-haspopup="listbox" aria-expanded="false">New</span>.
          </span>
          <span id="gltChunk" class="inline" style="display:none">
            GLT (PPED):
            <span id="gltField" class="word" role="button" aria-haspopup="listbox" aria-expanded="false">No</span>.
          </span>
        </div>

        <div class="cta">
          <button id="resolveBtn" class="btn primary">Resolve Tier</button>
          <button id="resetBtn" class="btn">Reset</button>
        </div>

        <!-- Results card -->
        <section class="card" id="outCard" style="display:none">
          <div class="card-h">
            <div class="title">Resolved Tier Value = <span id="resolvedTier">-</span></div>
            <span id="matchCount" class="pill">0 matches</span>
          </div>
          <div class="card-b">
            <!-- header row -->
            <div class="results-grid-header" id="resultHeader" style="display:none">
              <div>Category</div>
              <div>Phase</div>
              <div>Activity</div>
              <div>Key Outcome / Key Message</div>
              <div>Actions</div>
            </div>

            <!-- rows -->
            <div id="resultList" class="list"></div>

            <!-- bottom-right tools -->
            <div class="tools" id="downloadWrap" style="display:none">
              <button id="downloadBtn" class="btn">Download Tasks</button>
            </div>
          </div>
        </section>
      </section>
    </section>

    <!-- Compact Contact -->
    <section class="panel hero" id="contact">
      <h2 class="contact-title">Contact Us</h2>
      <h2 class="contact-email" style="text-align:center; font-size:16px; font-weight:600; margin:6px 0 0;">
        <a href="mailto:Alexandrine.Dominique.F.Delfin@gds.ey.com">
          Alexandrine.Dominique.F.Delfin@gds.ey.com
        </a>
      </h2>
    </section>
  </main>

  <!-- Popover templates -->
  <template id="tpl-multi">
    <div class="popover">
      <div class="pop-title"></div>
      <div class="opts"></div>
      <div class="actions">
        <button class="btn" data-act="clear">Clear</button>
        <button class="btn apply" data-act="apply">Apply</button>
      </div>
    </div>
  </template>

  <template id="tpl-single">
    <div class="popover">
      <div class="pop-title"></div>
      <div class="opts"></div>
    </div>
  </template>

  <!-- Site JS -->
  <script src="assets/js/script.js"></script>

  <!-- Public XML loader for <Record> + <Tiers><T name="tier_…"> -->
  <script>
  (function(){
    const XML_SOURCES = [
      'https://cdn.jsdelivr.net/gh/markcolobong/cnslegoblocks@main/data/records.xml',
      'https://raw.githubusercontent.com/markcolobong/cnslegoblocks/main/data/records.xml'
    ];
    const LIVE_KEY = 'settings_records_live';
    const OLD_KEY  = 'settings_records_v10';

    let SETTINGS = null;

    const lc = s => String(s||'').toLowerCase();
    const all = (root) => Array.from(root.getElementsByTagName('*'));
    const byTag = (root, tag) => all(root).filter(el => lc(el.localName||el.tagName) === lc(tag));
    const firstText = (el, tag) => {
      const hit = Array.from(el.children||[]).find(c => lc(c.localName||c.tagName) === lc(tag));
      return hit ? (hit.textContent||'').trim() : '';
    };

    function parseTiers(recordEl){
      const tiers = { tier_1:'', tier_1_1:'', tier_1_2:'', tier_2:'', tier_2_1:'', tier_3:'', tier_3_1:'', tier_3_2:'' };
      const tiersNode = byTag(recordEl, 'Tiers')[0];
      if (!tiersNode) return tiers;
      const tNodes = Array.from(tiersNode.children || []).filter(n => lc(n.localName||n.tagName) === 't');
      for (const t of tNodes){
        const name = (t.getAttribute('name') || '').trim(); // e.g., "tier_1_1"
        if (!name) continue;
        const key = lc(name);
        if (Object.prototype.hasOwnProperty.call(tiers, key)) {
          tiers[key] = (t.textContent || '').trim();
        }
      }
      return tiers;
    }

    function parseRecords(xmlText){
      const doc = new DOMParser().parseFromString(xmlText, 'application/xml');
      if (doc.querySelector('parsererror')) throw new Error('XML parse error');

      let recNodes = byTag(doc, 'Record');
      if (!recNodes.length) {
        const container = byTag(doc, 'Records')[0];
        if (container) recNodes = Array.from(container.children || []);
      }

      const out = recNodes.map(rec => {
        const linksNode = byTag(rec,'Links')[0];
        const links = linksNode
          ? Array.from(linksNode.children||[])
              .filter(l => lc(l.localName||l.tagName)==='link')
              .map(l => ({ label: firstText(l,'Label'), url: firstText(l,'Url') }))
              .filter(x => x.label || x.url)
          : [];

        const attsNode = byTag(rec,'Attachments')[0];
        const attachments = attsNode
          ? Array.from(attsNode.children||[])
              .filter(f => lc(f.localName||f.tagName)==='file')
              .map(f => ({ name: firstText(f,'Name'), url: firstText(f,'Url') }))
              .filter(x => x.name || x.url)
          : [];

        return {
          id: (rec.getAttribute('id') || firstText(rec,'Id') || '').trim(),
          category: firstText(rec,'Category'),
          phase: firstText(rec,'Phase'),
          activity: firstText(rec,'Activity'),
          outcome: firstText(rec,'Outcome'),
          presentationOwner: firstText(rec,'PresentationOwner'),
          contentOwner: firstText(rec,'ContentOwner'),
          notes: firstText(rec,'Notes'),
          links, attachments,
          tiers: parseTiers(rec)
        };
      });

      return out.filter(r => r.category || r.activity || r.outcome);
    }

    async function fetchXML(){
      let lastErr;
      for (const url of XML_SOURCES){
        try{
          const res = await fetch(url + '?_=' + Date.now(), { cache: 'no-store' }); // simple GET
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const xml = await res.text();
          const arr = parseRecords(xml);
          SETTINGS = Array.isArray(arr) ? arr : [];
          try { localStorage.setItem(LIVE_KEY, JSON.stringify(SETTINGS)); } catch {}
          return SETTINGS;
        }catch(e){ lastErr = e; }
      }
      // cache fallback
      try { const v = localStorage.getItem(LIVE_KEY); if (v) { SETTINGS = JSON.parse(v); return SETTINGS; } } catch {}
      try { const v = localStorage.getItem(OLD_KEY);  if (v) { SETTINGS = JSON.parse(v); return SETTINGS; } } catch {}
      if (lastErr) console.warn('records.xml fetch/parse issue:', lastErr);
      SETTINGS = [];
      return SETTINGS;
    }

    // public hooks used by the resolver below
    window.ensureFreshRecords = () => fetchXML();
    window.loadSettings = () =>
      SETTINGS
      || (function(){ try{ const v = localStorage.getItem(LIVE_KEY); if (v) return JSON.parse(v); }catch{} try{ const v = localStorage.getItem(OLD_KEY); if (v) return JSON.parse(v); }catch{} return []; })();

    // prefetch on load
    document.addEventListener('DOMContentLoaded', () => { fetchXML(); });
  })();
  </script>

  <!-- Resolver logic -->
  <script>
  (function(){
    /* ---------- Constants / data ---------- */
    const LEVEL_EXEC = "Partner/Principal, C-Suites, Executives";
    const LEVEL_DIRS = "Senior Managers, Directors, Department Head";
    const LEVELS = [LEVEL_EXEC, LEVEL_DIRS];

    const TYPES  = ["Customer","EY Member Firm","EY GDS"];
    const CUSTOMER_TYPES = ["New","Existing"];
    const YESNO = ["Yes","No"];

    const PRIORITY = ["1","1.1","1.2","2","2.1","3","3.1","3.2"];
    const TIER_FIELD = {
      "1":"tier_1","1.1":"tier_1_1","1.2":"tier_1_2",
      "2":"tier_2","2.1":"tier_2_1",
      "3":"tier_3","3.1":"tier_3_1","3.2":"tier_3_2"
    };

    const SETTINGS_LS_KEY = 'settings_records_v10';
    const STORE = "lego_home_widget_v3";

    /* ---------- Elements ---------- */
    const $ = (id)=>document.getElementById(id);
    const els = {
      levelField: $('levelField'),
      typeField: $('typeField'),
      custField: $('custField'),
      customerChunk: $('customerChunk'),
      gltChunk: $('gltChunk'),
      gltField: $('gltField'),
      resolveBtn: $('resolveBtn'),
      resetBtn: $('resetBtn'),
      tMulti: document.getElementById('tpl-multi'),
      tSingle: document.getElementById('tpl-single'),
      outCard: $('outCard'),
      resolvedTier: $('resolvedTier'),
      matchCount: $('matchCount'),
      resultHeader: $('resultHeader'),
      resultList: $('resultList'),
      downloadWrap: $('downloadWrap'),
      downloadBtn: $('downloadBtn')
    };

    /* ---------- State ---------- */
    let state = { levels:[], types:[], customerType:"New", glt:"No" };
    let currentResults = [];
    let lastTier = '-';

    /* ---------- Utils ---------- */
    const toASCII = (s) => String(s||'').replace(/[^\x20-\x7E]/g, "");
    const fmtAll = (arr)=> (!arr || !arr.length) ? "any" : toASCII(arr.join(", "));
    const escapeHTML = (s)=> String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    const trunc = (s,n)=>{ s=String(s||''); return s.length>n ? s.slice(0,n-1)+'...' : s; };

    function loadSession(){ try{ Object.assign(state, JSON.parse(sessionStorage.getItem(STORE)||'{}')); }catch{} syncUI(); }
    function saveSession(){ sessionStorage.setItem(STORE, JSON.stringify(state)); }

    /* ---------- Tier logic (original) ---------- */
    function computeResolvedTier(){
      const matches = new Set();
      state.types.forEach(type=>{
        state.levels.forEach(level=>{
          if(type === "Customer"){
            if(level === LEVEL_EXEC){
              if(state.customerType === "Existing") matches.add("1");
              else if(state.customerType === "New") matches.add("1.1");
              else matches.add("1.1");
            }
            if(level === LEVEL_DIRS){ matches.add("1.2"); }
          }
          if(type === "EY Member Firm"){
            if(level === LEVEL_EXEC) matches.add("2");
            if(level === LEVEL_DIRS) matches.add("2.1");
          }
          if(type === "EY GDS"){
            if(level === LEVEL_EXEC){ matches.add(state.glt === "Yes" ? "3" : "3.1"); }
            if(level === LEVEL_DIRS){ matches.add("3.2"); }
          }
        });
      });
      for(const t of PRIORITY){ if(matches.has(t)) return t; }
      return "-";
    }

    /* ---------- UI sync ---------- */
    function syncUI(){
      const hasLevels = state.levels.length>0;
      els.levelField.textContent = hasLevels ? fmtAll(state.levels) : "any level";
      els.levelField.classList.toggle('empty', !hasLevels);
      els.levelField.classList.toggle('selected', hasLevels);

      const hasTypes = state.types.length>0;
      els.typeField.textContent = hasTypes ? fmtAll(state.types) : "any type";
      els.typeField.classList.toggle('empty', !hasTypes);
      els.typeField.classList.toggle('selected', hasTypes);

      const isCustomer = state.types.includes("Customer");
      els.customerChunk.style.display = isCustomer ? "inline-flex" : "none";
      if(isCustomer){ els.custField.textContent = toASCII(state.customerType || "New"); els.custField.classList.add('selected'); }
      else { els.custField.classList.remove('selected'); }

      const showGLT = state.types.includes("EY GDS") && state.levels.includes(LEVEL_EXEC);
      els.gltChunk.style.display = showGLT ? "inline-flex" : "none";
      if(showGLT){ els.gltField.textContent = toASCII(state.glt || "No"); els.gltField.classList.add('selected'); }
      else { els.gltField.classList.remove('selected'); }
    }

    /* ---------- Mini popover engine (robust single-toggle) ---------- */
    let openPop = null;
    function closePop(){ if(openPop){ openPop.remove(); openPop=null; } }
    document.addEventListener('click', (e)=>{ if(openPop && !openPop.contains(e.target) && !e.target.classList.contains('word')) closePop(); });

    function position(anchor, pop){
      const r = anchor.getBoundingClientRect();
      pop.style.minWidth = Math.max(320, r.width+40) + "px";
      pop.style.left = (window.scrollX + r.left) + "px";
      pop.style.top  = (window.scrollY + r.bottom + 6) + "px";
    }

    function makeMultiPopover(anchor, title, options, selected){
      closePop();
      const node = els.tMulti.content.firstElementChild.cloneNode(true);
      node.querySelector('.pop-title').textContent = title;
      const box = node.querySelector('.opts');

      options.forEach(opt=>{
        const row = document.createElement('div');
        row.className='opt';
        row.innerHTML = '<input type="checkbox"> <span>'+toASCII(opt)+'</span>';
        const cb = row.querySelector('input');
        cb.checked = selected.includes(opt);

        cb.addEventListener('click', ev => ev.stopPropagation());
        row.addEventListener('click', () => { cb.checked = !cb.checked; });

        box.appendChild(row);
      });

      node.querySelector('[data-act="clear"]').addEventListener('click', ()=> {
        box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false);
      });
      node.querySelector('[data-act="apply"]').addEventListener('click', ()=>{
        const picked = Array.from(box.querySelectorAll('input:checked')).map(cb=>cb.nextElementSibling.textContent);
        anchor._apply(picked);
        closePop();
      });

      position(anchor, node); openPop=node; document.body.appendChild(node);
    }

    function makeSinglePopover(anchor, title, options, current){
      closePop();
      const node = els.tSingle.content.firstElementChild.cloneNode(true);
      node.querySelector('.pop-title').textContent = title;
      const box = node.querySelector('.opts');

      options.forEach(opt=>{
        const row = document.createElement('div');
        row.className='opt';
        row.innerHTML = '<input type="radio" name="single"> <span>'+toASCII(opt)+'</span>';
        const rb = row.querySelector('input');
        rb.checked = (current===opt);

        rb.addEventListener('click', ev => ev.stopPropagation());
        row.addEventListener('click', () => {
          rb.checked = true;
          anchor._apply(opt);
          closePop();
        });

        box.appendChild(row);
      });

      position(anchor, node); openPop=node; document.body.appendChild(node);
    }

    // Bind chips
    els.levelField.addEventListener('click', function(){
      this._apply = picked => { state.levels = picked.map(toASCII); syncUI(); saveSession(); };
      makeMultiPopover(this, "Visitor Level (multi-select)", LEVELS, state.levels);
    });
    els.typeField.addEventListener('click', function(){
      this._apply = picked => { state.types = picked.map(toASCII); syncUI(); saveSession(); };
      makeMultiPopover(this, "Visitor Type (multi-select)", TYPES, state.types);
    });
    els.custField.addEventListener('click', function(){
      this._apply = val => { state.customerType = toASCII(val); syncUI(); saveSession(); };
      makeSinglePopover(this, "Customer Type", CUSTOMER_TYPES, state.customerType);
    });
    els.gltField.addEventListener('click', function(){
      this._apply = val => { state.glt = toASCII(val); syncUI(); saveSession(); };
      makeSinglePopover(this, "GLT - Is the PPED part of GLT?", YESNO, state.glt);
    });

    /* ---------- Settings + Results ---------- */
    // loader is defined above
    function loadSettings(){
      return (window.loadSettings && window.loadSettings()) || [];
    }

    // tolerant applicability check
    function isApplicable(v){
      const s = String(v || '')
        .replace(/[\u00A0\u1680\u180E\u2000-\u200D\u202F\u205F\u2060\u3000\uFEFF]/g, ' ')
        .trim()
        .toLowerCase();
      return s === 'applicable'
          || s.startsWith('applicable ')
          || s === 'case to case'
          || s === 'case-to-case'
          || s === 'case by case'
          || s === 'yes'
          || s === 'true'
          || s === 'y'
          || s === '1';
    }

    function filterByResolvedTier(tierCode){
      if(!tierCode) return [];
      const field = {
        "1":"tier_1","1.1":"tier_1_1","1.2":"tier_1_2",
        "2":"tier_2","2.1":"tier_2_1","3":"tier_3","3.1":"tier_3_1","3.2":"tier_3_2"
      }[tierCode];
      if(!field) return [];
      const data = loadSettings();
      return data.filter(rec=>{
        const raw = ((rec.tiers||{})[field]||'');
        return isApplicable(raw);
      });
    }

    /* ---------- Stable rendering + delete ---------- */
    function rowHTML(r,i){
      return `
        <div class="row" data-i="${i}">
          <div class="cap">${escapeHTML(toASCII(r.category||''))}</div>
          <div class="phase">${escapeHTML(toASCII(r.phase||''))}</div>
          <div class="act" title="${escapeHTML(toASCII(r.activity||''))}">
            ${escapeHTML(toASCII(r.activity||''))}
          </div>
          <div class="outcome" title="${escapeHTML(toASCII(r.outcome||''))}">
            ${escapeHTML(trunc(toASCII(r.outcome||''),110))}
          </div>
          <div class="actions">
            <button class="kill" title="delete" aria-label="delete" data-i="${i}">X</button>
          </div>
        </div>`;
    }

    function renderRows(){
      const hasRows = currentResults.length > 0;
      els.resultHeader.style.display = hasRows ? 'grid' : 'none';

      if(!hasRows){
        els.matchCount.textContent = '0 matches';
        els.resultList.innerHTML =
          `<div class="tiny" style="padding:6px 2px 10px">No records (after removals).</div>`;
        els.downloadWrap.style.display = 'none';
        return;
      }

      els.matchCount.textContent =
        `${currentResults.length} match${currentResults.length!==1?'es':''}`;
      els.resultList.innerHTML = currentResults.map(rowHTML).join('');
      els.downloadWrap.style.display = 'flex';
    }

    function renderResults(tierCode){
      lastTier = tierCode || '-';
      currentResults = filterByResolvedTier(lastTier);

      els.outCard.style.display = 'block';
      els.resolvedTier.textContent = lastTier;
      renderRows();
    }

    // One delegated handler – keeps layout after every delete
    els.resultList.addEventListener('click', (e)=>{
      const btn = e.target.closest('.kill');
      if(!btn) return;
      const idx = Number(btn.dataset.i);
      if(Number.isFinite(idx) && idx>=0 && idx<currentResults.length){
        currentResults.splice(idx, 1); // session-only removal
        renderRows();
      }
    });

    /* ---------- Export (ALL fields) ---------- */
    function csvEscape(v){ const s=String(v??''); return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }
    function linksToCsv(links=[]){
      return links.map(l=>{
        const label = (l && l.label) ? l.label : '';
        const url = (l && l.url) ? l.url : '';
        if(!label && !url) return '';
        return `${label}|${url}`;
      }).filter(Boolean).join(' || ');
    }
    function attsToCsv(atts=[]){ return (atts||[]).map(a=>a && a.name ? a.name : '').filter(Boolean).join(' | '); }

    function downloadTasks(tierCode){
      const all = loadSettings();
      if(!all.length) return;

      const headers = [
        'Resolved Tier',
        'ID','Category','Phase','Activity','Key Outcome / Key Message',
        'Presentation Owner','Content Owner','Notes','URL/Links','Attachments',
        'Tier 1','Tier 1.1','Tier 1.2','Tier 2','Tier 2.1','Tier 3','Tier 3.1','Tier 3.2'
      ];
      const lines = [ headers.map(csvEscape).join(',') ];

      all.forEach(r=>{
        const t = r.tiers || {};
        const row = [
          tierCode || '-',
          r.id || '',
          toASCII(r.category||''), toASCII(r.phase||''), toASCII(r.activity||''), toASCII(r.outcome||''),
          toASCII(r.presentationOwner||''), toASCII(r.contentOwner||''), toASCII(r.notes||''),
          linksToCsv(r.links||[]), attsToCsv(r.attachments||[]),
          t.tier_1||'', t.tier_1_1||'', t.tier_1_2||'',
          t.tier_2||'', t.tier_2_1||'',
          t.tier_3||'', t.tier_3_1||'', t.tier_3_2||'',
        ];
        lines.push(row.map(csvEscape).join(','));
      });

      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), {href:url, download:'Tasks_AllFields.csv'});
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    /* ---------- Actions ---------- */
    els.resolveBtn.addEventListener('click', async ()=>{
      // refresh public XML before computing/filtering
      await (window.ensureFreshRecords ? window.ensureFreshRecords() : Promise.resolve());
      const tier = computeResolvedTier();
      renderResults(tier);
      window.scrollTo({ top: els.outCard.offsetTop - 80, behavior: 'smooth' });
    });
    els.downloadBtn.addEventListener('click', ()=>{
      const tier = els.resolvedTier.textContent || '-';
      downloadTasks(tier);
    });
    els.resetBtn.addEventListener('click', ()=>{
      state = { levels:[], types:[], customerType:"New", glt:"No" };
      syncUI(); saveSession();
      els.outCard.style.display = 'none';
    });

    /* ---------- Init ---------- */
    loadSession();
  })();
  </script>
</body>
</html>
